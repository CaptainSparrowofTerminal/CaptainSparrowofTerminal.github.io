<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compass - Pirate Social</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%230a0e27' stroke='%23d4af37' stroke-width='3'/%3E%3Cpath d='M50 20 L55 45 L50 50 L45 45 Z' fill='%2300ff41'/%3E%3Cpath d='M50 80 L45 55 L50 50 L55 55 Z' fill='%23ff3366'/%3E%3Ccircle cx='50' cy='50' r='5' fill='%23d4af37'/%3E%3C/svg%3E">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, query, orderByChild, limitToLast, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDDtu5Kshx4TeRRQjFFbM-HUuvdoxLinDI",
            authDomain: "compass-chat-d8034.firebaseapp.com",
            databaseURL: "https://compass-chat-d8034-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "compass-chat-d8034",
            storageBucket: "compass-chat-d8034.firebasestorage.app",
            messagingSenderId: "669678028818",
            appId: "1:669678028818:web:3245ba2bb6d8c225fd30cb",
            measurementId: "G-8NWF6KZCT7"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseQuery = query;
        window.firebaseOrderByChild = orderByChild;
        window.firebaseLimitToLast = limitToLast;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseReady = true;
        
        console.log('âœ… Firebase initialized');
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Pirata+One&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-gold: #d4af37;
            --terminal-green: #dc143c;
            --dark-blue: #0a0e27;
            --darker-blue: #050811;
            --accent-red: #ff3366;
            --text-white: #e0e0e0;
            --border-color: rgba(220, 20, 60, 0.3);
        }
        
        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, var(--darker-blue) 0%, var(--dark-blue) 100%);
            color: var(--text-white);
            min-height: 100vh;
        }
        
        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .auth-modal.hidden {
            display: none;
        }
        
        .auth-container {
            background: linear-gradient(135deg, var(--darker-blue) 0%, var(--dark-blue) 100%);
            border: 2px solid var(--terminal-green);
            border-radius: 10px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 0 30px rgba(220, 20, 60, 0.3);
        }
        
        .auth-logo {
            font-family: 'Pirata One', cursive;
            font-size: 2.5rem;
            color: var(--primary-gold);
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 20px var(--terminal-green);
        }
        
        .auth-subtitle {
            text-align: center;
            color: var(--terminal-green);
            font-size: 0.9rem;
            margin-bottom: 30px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .auth-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .auth-label {
            color: var(--primary-gold);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .auth-input {
            background: rgba(220, 20, 60, 0.1);
            border: 1px solid var(--terminal-green);
            border-radius: 5px;
            padding: 12px 15px;
            color: var(--text-white);
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: var(--primary-gold);
        }
        
        .auth-button {
            background: linear-gradient(135deg, var(--terminal-green) 0%, var(--accent-red) 100%);
            border: none;
            border-radius: 5px;
            padding: 15px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        .auth-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .auth-switch-link {
            color: var(--primary-gold);
            cursor: pointer;
            text-decoration: underline;
        }
        
        .auth-error, .auth-success {
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            text-align: center;
            display: none;
        }
        
        .auth-error {
            background: rgba(255, 51, 102, 0.2);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }
        
        .auth-success {
            background: rgba(0, 255, 65, 0.2);
            border: 1px solid #00ff41;
            color: #00ff41;
        }
        
        .auth-error.show, .auth-success.show {
            display: block;
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            padding: 20px;
            border-right: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .logo-section {
            margin-bottom: 40px;
        }
        
        .logo {
            font-family: 'Pirata One', cursive;
            font-size: 2rem;
            color: var(--primary-gold);
            text-shadow: 0 0 10px var(--terminal-green);
            margin-bottom: 5px;
        }
        
        .logo-subtitle {
            color: var(--terminal-green);
            font-size: 0.8rem;
        }
        
        .nav-menu {
            list-style: none;
            margin-bottom: 40px;
            flex-grow: 1;
        }
        
        .nav-item {
            padding: 15px 20px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(220, 20, 60, 0.15);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: rgba(220, 20, 60, 0.25);
            color: var(--primary-gold);
            box-shadow: 0 2px 8px rgba(220, 20, 60, 0.2);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: var(--primary-gold);
            border-radius: 0 4px 4px 0;
        }
        
        .nav-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-icon svg {
            transition: all 0.2s ease;
        }
        
        .nav-item.active .nav-icon svg {
            stroke: var(--primary-gold);
        }
        
        .user-info-sidebar {
            padding: 15px;
            background: rgba(220, 20, 60, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-top: auto;
            flex-shrink: 0;
        }
        
        .user-name {
            color: var(--primary-gold);
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .user-handle {
            color: var(--text-white);
            opacity: 0.7;
            font-size: 0.9rem;
        }
        
        .logout-btn {
            margin-top: 10px;
            background: transparent;
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-family: 'Orbitron', sans-serif;
        }
        
        /* Feed Section */
        .feed-section {
            flex: 1;
            max-width: 600px;
            border-right: 1px solid var(--border-color);
        }
        
        .feed-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        
        .feed-title {
            font-size: 1.5rem;
            color: var(--primary-gold);
            font-weight: 700;
        }
        
        /* Post Box */
        .post-box {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.02);
            margin: 10px;
            border-radius: 16px;
            border: 1px solid rgba(220, 20, 60, 0.2);
        }
        
        .post-input-container {
            display: flex;
            gap: 15px;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--terminal-green), var(--primary-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(220, 20, 60, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.2);
        }
        
        .post-input-area {
            flex: 1;
        }
        
        .post-textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-white);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            resize: none;
            min-height: 80px;
            outline: none;
        }
        
        .post-textarea::placeholder {
            color: rgba(224, 224, 224, 0.5);
        }
        
        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .post-icons {
            display: flex;
            gap: 15px;
        }
        
        .post-icon {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .post-icon svg {
            color: #1d9bf0;
            transition: all 0.2s ease;
        }
        
        .post-icon:hover {
            background: rgba(29, 155, 240, 0.1);
        }
        
        .post-icon:hover svg {
            color: #1d9bf0;
        }
        
        .post-button {
            background: linear-gradient(135deg, var(--terminal-green), var(--accent-red));
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
        }
        
        .post-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 20, 60, 0.4);
        }
        
        .post-button:active {
            transform: translateY(0);
        }
        
        .post-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .post-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Feed Posts */
        .feed-posts {
            padding: 10px;
        }
        
        .post {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(220, 20, 60, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .post:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(220, 20, 60, 0.4);
            box-shadow: 0 4px 16px rgba(220, 20, 60, 0.15);
            transform: translateY(-2px);
        }
        
        .post-header {
            display: flex;
            gap: 15px;
            position: relative;
        }
        
        .post-menu-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: rgba(224, 224, 224, 0.5);
        }
        
        .post-menu-btn:hover {
            background: rgba(220, 20, 60, 0.15);
            color: var(--primary-gold);
        }
        
        .post-menu-dropdown {
            position: absolute;
            top: 40px;
            right: 0;
            background: var(--dark-blue);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }
        
        .post-menu-dropdown.show {
            display: block;
        }
        
        .post-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-white);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .post-menu-item:hover {
            background: rgba(220, 20, 60, 0.15);
        }
        
        .post-menu-item.delete {
            color: var(--accent-red);
        }
        
        .post-menu-item.delete:hover {
            background: rgba(255, 51, 102, 0.15);
        }
        
        .post-content-area {
            flex: 1;
        }
        
        .post-user-info {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .post-username {
            color: var(--primary-gold);
            font-weight: 700;
            font-size: 1rem;
        }
        
        .post-handle {
            color: var(--text-white);
            opacity: 0.5;
            font-size: 0.9rem;
        }
        
        .post-time {
            color: var(--text-white);
            opacity: 0.5;
            font-size: 0.9rem;
        }
        
        .post-text {
            color: var(--text-white);
            line-height: 1.7;
            margin-bottom: 16px;
            word-wrap: break-word;
            font-size: 1rem;
        }
        
        .post-stats {
            display: flex;
            gap: 40px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(220, 20, 60, 0.15);
        }
        
        .post-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.95rem;
            color: rgba(224, 224, 224, 0.6);
        }
        
        .post-stat span {
            color: rgba(224, 224, 224, 0.8);
            font-size: 0.9rem;
        }
        
        .post-stat svg {
            transition: all 0.2s ease;
        }
        
        .post-stat:hover {
            background: rgba(220, 20, 60, 0.1);
        }
        
        .post-stat:hover span {
            color: currentColor;
        }
        
        /* Comment icon - blue on hover */
        .post-stat:nth-child(1):hover {
            color: #1d9bf0;
        }
        
        .post-stat:nth-child(1):hover svg {
            stroke: #1d9bf0;
        }
        
        /* Retweet icon - green on hover */
        .post-stat:nth-child(2):hover {
            color: #00ba7c;
        }
        
        .post-stat:nth-child(2):hover svg {
            stroke: #00ba7c;
        }
        
        /* Like icon - pink on hover */
        .post-stat:nth-child(3):hover {
            color: #f91880;
        }
        
        .post-stat:nth-child(3):hover svg {
            stroke: #f91880;
            fill: #f91880;
        }
        
        /* Views icon - Solana green on hover */
        .post-stat:nth-child(4):hover {
            color: #14F195;
        }
        
        .post-stat:nth-child(4):hover svg {
            stroke: #14F195;
        }
        
        .post-stat.liked {
            color: #f91880;
        }
        
        .post-stat.liked svg {
            stroke: #f91880 !important;
            fill: #f91880 !important;
        }
        
        .post-stat.retweeted {
            color: var(--terminal-green);
        }
        
        .post-stat.retweeted svg {
            stroke: var(--terminal-green) !important;
        }
        
        /* Search Tabs */
        .search-tab.active {
            color: var(--primary-gold) !important;
            border-bottom-color: var(--primary-gold) !important;
        }
        
        .search-tab:hover {
            color: var(--primary-gold);
        }
        
        #searchInput:focus {
            border-color: var(--primary-gold);
            background: rgba(212, 175, 55, 0.05);
        }
        
        .search-user-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .search-user-card:hover {
            background: rgba(220, 20, 60, 0.05);
        }
        
        .search-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--terminal-green), var(--primary-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-white);
            flex-shrink: 0;
        }
        
        .search-user-info {
            flex: 1;
        }
        
        .search-user-name {
            font-size: 1rem;
            font-weight: bold;
            color: var(--text-white);
        }
        
        .search-user-handle {
            font-size: 0.9rem;
            color: var(--text-white);
            opacity: 0.6;
        }
        
        /* Right Sidebar */
        .right-sidebar {
            width: 350px;
            padding: 20px;
        }
        
        .trending-section {
            background: rgba(220, 20, 60, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            color: var(--primary-gold);
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .trending-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .trending-item:last-child {
            border-bottom: none;
        }
        
        .trending-category {
            color: var(--text-white);
            opacity: 0.6;
            font-size: 0.8rem;
        }
        
        .trending-topic {
            color: var(--text-white);
            font-weight: 700;
            margin: 5px 0;
        }
        
        .trending-count {
            color: var(--text-white);
            opacity: 0.6;
            font-size: 0.9rem;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .right-sidebar {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }
            
            .nav-text {
                display: none;
            }
            
            .logo-section {
                text-align: center;
            }
            
            .logo {
                font-size: 1.5rem;
            }
            
            .logo-subtitle {
                display: none;
            }
            
            .user-info-sidebar {
                display: none;
            }
        }
        
        /* Comment Modal */
        .comment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .comment-modal.active {
            display: flex;
        }
        
        .comment-modal-content {
            background: var(--dark-blue);
            border: 2px solid var(--terminal-green);
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .comment-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comment-modal-title {
            color: var(--primary-gold);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .close-modal {
            background: transparent;
            border: none;
            color: var(--text-white);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }
        
        .original-post {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .comment-input-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .comment-textarea {
            width: 100%;
            background: rgba(220, 20, 60, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 12px;
            color: var(--text-white);
            font-family: 'Orbitron', sans-serif;
            resize: none;
            min-height: 80px;
            margin-bottom: 15px;
        }
        
        .comment-textarea:focus {
            outline: none;
            border-color: var(--primary-gold);
        }
        
        .comment-button {
            background: var(--terminal-green);
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            float: right;
        }
        
        .comments-list {
            padding: 20px;
        }
        
        .comment-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(220, 20, 60, 0.15);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .comment-item:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(220, 20, 60, 0.25);
        }
        
        .comment-item:last-child {
            margin-bottom: 0;
        }
        
        /* Image Upload */
        .image-preview {
            margin-top: 15px;
            position: relative;
            display: none;
        }
        
        .image-preview.active {
            display: block;
        }
        
        .preview-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .post-image {
            width: 100%;
            max-height: 500px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 12px;
            cursor: pointer;
            border: 1px solid rgba(220, 20, 60, 0.2);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .post-image:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(220, 20, 60, 0.3);
        }
        
        /* Follow Button Styles */
        .follow-btn {
            background: linear-gradient(135deg, var(--terminal-green), var(--accent-red));
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .follow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.4);
        }
        
        .follow-btn.following {
            background: transparent;
            border: 1px solid var(--terminal-green);
            color: var(--terminal-green);
        }
        
        .follow-btn.following:hover {
            background: rgba(220, 20, 60, 0.1);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }
        
        .user-suggest-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .user-suggest-item:hover {
            background: rgba(220, 20, 60, 0.1);
        }
        
        .user-suggest-info {
            flex: 1;
        }
        
        .user-suggest-name {
            color: var(--primary-gold);
            font-weight: 700;
            margin-bottom: 3px;
            font-size: 0.95rem;
        }
        
        .user-suggest-bio {
            color: var(--text-white);
            opacity: 0.7;
            font-size: 0.75rem;
        }
        
        /* Followers/Following Modal */
        .followers-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .followers-modal.active {
            display: flex;
        }
        
        .followers-modal-content {
            background: linear-gradient(135deg, var(--darker-blue) 0%, var(--dark-blue) 100%);
            border: 2px solid var(--terminal-green);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(220, 20, 60, 0.5);
        }
        
        .followers-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .followers-modal-title {
            font-size: 1.3rem;
            color: var(--primary-gold);
            font-weight: 700;
        }
        
        .followers-modal-close {
            background: transparent;
            border: none;
            color: var(--accent-red);
            font-size: 1.5rem;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .followers-modal-close:hover {
            background: rgba(255, 51, 102, 0.2);
        }
        
        .followers-modal-list {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .follower-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(220, 20, 60, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .follower-item:hover {
            background: rgba(220, 20, 60, 0.2);
            border-color: var(--terminal-green);
        }
        
        .follower-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .follower-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--terminal-green), var(--primary-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            flex-shrink: 0;
            border: 2px solid rgba(212, 175, 55, 0.3);
        }
        
        .follower-details {
            flex: 1;
        }
        
        .follower-name {
            color: var(--primary-gold);
            font-weight: 700;
            margin-bottom: 3px;
            font-size: 1rem;
        }
        
        .follower-username {
            color: var(--text-white);
            opacity: 0.7;
            font-size: 0.85rem;
        }
        
        .follower-bio {
            color: var(--text-white);
            opacity: 0.6;
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .followers-modal-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-white);
            opacity: 0.5;
            font-size: 1.1rem;
        }
    
        /* Notifications */
        .notif-badge {
            display: none;
            min-width: 18px;
            height: 18px;
            padding: 0 6px;
            border-radius: 999px;
            background: var(--accent-red);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 18px;
            text-align: center;
            margin-left: auto;
        }

        .notifications-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mark-read-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-white);
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .mark-read-btn:hover {
            border-color: var(--primary-gold);
            color: var(--primary-gold);
            background: rgba(212, 175, 55, 0.06);
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .notification-item:hover {
            background: rgba(220, 20, 60, 0.06);
        }

        .notification-item.unread {
            background: rgba(220, 20, 60, 0.10);
        }

        .notification-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--terminal-green), var(--primary-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            flex-shrink: 0;
            border: 2px solid rgba(212, 175, 55, 0.2);
        }

        .notification-body {
            flex: 1;
        }

        .notification-title {
            color: var(--text-white);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .notification-title b {
            color: var(--primary-gold);
        }

        .notification-time {
            margin-top: 6px;
            font-size: 0.8rem;
            opacity: 0.6;
        }

    
        .notif-item {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .notif-item:hover {
            background: rgba(220, 20, 60, 0.08);
        }
        .notif-item.notif-unread {
            background: rgba(212, 175, 55, 0.06);
        }
        .notif-text {
            color: var(--text-white);
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .notif-time {
            margin-top: 6px;
            color: rgba(224, 224, 224, 0.55);
            font-size: 0.8rem;
        }
    

        /* --- NOTIFICATIONS VISIBILITY PATCH v10 --- */
        #notificationsPage {
            position: relative;
            z-index: 5;
            width: 100%;
        }
        #notificationsPage .feed-header {
            position: sticky;
            top: 0;
            z-index: 6;
        }
        /* In case something sets pages invisible */
        #notificationsPage[style*="display: block"] {
            visibility: visible !important;
            opacity: 1 !important;
        }
        /* --- END PATCH v10 --- */


        /* --- X-LIKE NOTIFICATIONS UI v11 --- */
        #notificationsList {
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .notif-row {
            display: grid;
            grid-template-columns: 36px 44px 1fr;
            gap: 10px;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
            align-items: start;
            transition: background 0.15s ease, transform 0.15s ease;
        }
        .notif-row:hover { background: rgba(255,255,255,0.04); }
        .notif-unread { background: rgba(255, 0, 128, 0.07); }
        .notif-lefticon {
            font-size: 20px;
            line-height: 1;
            margin-top: 2px;
            filter: drop-shadow(0 0 6px rgba(255, 0, 128, 0.25));
        }
        .notif-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.10);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .notif-avatar-inner {
            font-weight: 700;
            color: var(--primary-gold);
            font-size: 16px;
        }
        .notif-body { min-width: 0; }
        .notif-topline {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 2px;
        }
        .notif-name {
            color: var(--text-white);
            font-weight: 800;
            font-size: 15px;
        }
        .notif-handle {
            color: rgba(255,255,255,0.60);
            font-size: 13px;
        }
        .notif-dot {
            color: rgba(255,255,255,0.45);
            margin: 0 2px;
        }
        .notif-time {
            color: rgba(255,255,255,0.55);
            font-size: 13px;
        }
        .notif-action {
            color: rgba(255,255,255,0.92);
            font-size: 14px;
            margin-bottom: 6px;
        }
        .notif-snippet {
            color: rgba(255,255,255,0.65);
            font-size: 13px;
            line-height: 1.35;
            max-width: 620px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        /* --- END v11 --- */


        /* --- NOTIFICATIONS OVERLAY FAILSAFE v15 --- */
        .notif-overlay { position: fixed; inset: 0; z-index: 9999; }
        .notif-overlay-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); }
        .notif-overlay-panel {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: min(720px, calc(100vw - 32px));
            max-height: calc(100vh - 120px);
            overflow: auto;
            background: rgba(10, 14, 39, 0.96);
            border: 1px solid rgba(255, 0, 128, 0.25);
            border-radius: 18px;
            box-shadow: 0 12px 50px rgba(0,0,0,0.55);
        }
        .notif-overlay-header{
            position: sticky;
            top: 0;
            z-index: 1;
            display:flex;
            justify-content: space-between;
            align-items:center;
            gap:12px;
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            background: rgba(10, 14, 39, 0.96);
        }
        .notif-overlay-title{ font-weight: 800; color: var(--text-white); font-size: 16px; }
        .notif-overlay-actions{ display:flex; gap:10px; align-items:center; }
        .notif-overlay-close{
            width: 38px; height: 38px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06);
            color: var(--text-white);
            cursor: pointer;
        }
        .notif-overlay-close:hover{ background: rgba(255,255,255,0.10); }
        #notificationsOverlayList{ border-top: 0; }
        /* --- END v15 --- */


        /* ===== MVP Responsive (v7) ===== */
        .mobile-menu-btn{
            display:none;
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.10);
            color: var(--text-white);
            border-radius: 10px;
            padding: 8px 12px;
            cursor:pointer;
            margin-left: 10px;
        }
        @media (max-width: 900px){
            .mobile-menu-btn{ display:inline-flex; align-items:center; justify-content:center; }
            .container{ padding: 10px; }
            .layout{ grid-template-columns: 1fr !important; }
            .sidebar{ 
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: min(340px, 88vw);
                transform: translateX(-110%);
                transition: transform .22s ease;
                z-index: 9999;
                background: rgba(10,10,10,0.98);
                backdrop-filter: blur(10px);
                border-right: 1px solid var(--border-color);
                overflow-y: auto;
                padding-bottom: 24px;
            }
            body.mobile-sidebar-open .sidebar{ transform: translateX(0); }
            .mobile-backdrop{
                display:none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.55);
                z-index: 9998;
            }
            body.mobile-sidebar-open .mobile-backdrop{ display:block; }
            .main-content{ border-radius: 14px; }
            .comment-modal-content{ max-height: 86vh; overflow-y: auto; }
        }
        /* ===== End Responsive ===== */
    

        .link-tag, .link-mention{
            color: var(--terminal-green);
            text-decoration: none;
            font-weight: 700;
        }
        .link-tag:hover, .link-mention:hover{ text-decoration: underline; }
    
        .toast{
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            border: 1px solid rgba(255,255,255,0.12);
            color: var(--text-white);
            padding: 10px 14px;
            border-radius: 12px;
            z-index: 10000;
            opacity: 0;
            transition: opacity .18s ease;
            max-width: min(520px, 92vw);
            font-size: .95rem;
        }
        .toast.show{ opacity: 1; }


        /* ===== MVP: Network banner (v11) ===== */
        .net-banner{
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.88);
            border: 1px solid rgba(255,255,255,0.12);
            color: var(--text-white);
            padding: 10px 14px;
            border-radius: 14px;
            z-index: 10001;
            display:none;
            max-width: min(720px, 92vw);
            font-size: .95rem;
            backdrop-filter: blur(10px);
        }
        .net-banner.show{ display:block; }
    
</style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container">
            <div class="auth-logo">âš“ COMPASS âš“</div>
            <div class="auth-subtitle">Join the Pirate Crew</div>
            
            <div class="auth-error" id="authError"></div>
            <div class="auth-success" id="authSuccess"></div>
            
            <!-- Login Form -->
            <form class="auth-form" id="loginForm">
                <div class="auth-input-group">
                    <label class="auth-label">Username</label>
                    <input type="text" class="auth-input" id="loginUsername" placeholder="Enter username" required>
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">Password</label>
                    <input type="password" class="auth-input" id="loginPassword" placeholder="Enter password" required>
                </div>
                <button type="submit" class="auth-button">âš“ Set Sail</button>
            </form>
            
            <!-- Register Form -->
            <form class="auth-form" id="registerForm" style="display: none;">
                <div class="auth-input-group">
                    <label class="auth-label">Username</label>
                    <input type="text" class="auth-input" id="registerUsername" placeholder="Choose username" required minlength="3" maxlength="20">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">Password</label>
                    <input type="password" class="auth-input" id="registerPassword" placeholder="Choose password" required minlength="6">
                </div>
                <button type="submit" class="auth-button">âš“ Join Crew</button>
            </form>
            
            <div class="auth-switch">
                <span id="authSwitchText">Don't have an account?</span>
                <span class="auth-switch-link" id="authSwitchLink">Join the crew</span>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="logo-section">
                <div class="logo">
                    COMPASS ðŸ§­
                </div>
                <div class="logo-subtitle">Solana's Pirate Social Network</div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item active" onclick="switchPage('home')">
                    <span class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </span>
                    <span class="nav-text">Home</span>
                </li>
                <li class="nav-item" onclick="switchPage('trending')">
                    <span class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                        </svg>
                    </span>
                    <span class="nav-text">Trending</span>
                </li>
                <li class="nav-item" onclick="switchPage('search')">
                    <span class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </span>
                    <span class="nav-text">Search</span>
                </li>
                <li class="nav-item" onclick="openNotificationsOverlay()">
                    <span class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </span>
                    <span class="nav-text">Notifications</span>
                    <span class="notif-badge" id="notificationsBadge">0</span>
                </li>

                <li class="nav-item" onclick="switchPage('profile')">
                    <span class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </span>
                    <span class="nav-text">Profile</span>
                </li>
                <li class="nav-item" onclick="switchPage('settings')">
                    <span class="nav-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </span>
                    <span class="nav-text">Settings</span>
                </li>
            </ul>
            
            <div class="user-info-sidebar" id="sidebarUserInfo" style="display: none;">
                <div class="user-name" id="sidebarUserName"></div>
                <div class="user-handle" id="sidebarUserHandle"></div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </aside>
        
        <!-- Feed Section -->
        <main class="feed-section" id="mainContent">
            <!-- Home Page -->
            <div id="homePage">
                <div class="feed-header">
                    <h1 class="feed-title">Home</h1>
                    <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" aria-label="Menu">â˜°</button>
                </div>
                
                <!-- Post Box -->
                <div class="post-box">
                    <div class="post-input-container">
                        <div class="user-avatar" id="postAvatar">ðŸ´â€â˜ ï¸</div>
                        <div class="post-input-area">
                            <textarea 
                                class="post-textarea" 
                                id="postTextarea" 
                                placeholder="What's happening, pirate?"
                                maxlength="280"
                            ></textarea>
                            
                            <!-- Image Preview -->
                            <div class="image-preview" id="imagePreview">
                                <img id="previewImg" class="preview-image" alt="Preview">
                                <button class="remove-image" onclick="removeImage()">âœ•</button>
                            </div>
                            
                            <div class="post-actions">
                                <div class="post-icons">
                                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                                    <span class="post-icon" title="Add image" onclick="document.getElementById('imageInput').click()" style="cursor: pointer;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                            <polyline points="21 15 16 10 5 21"></polyline>
                                        </svg>
                                    </span>
                                </div>
                                <button class="post-button" id="postButton" onclick="createPost()">Post</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Feed Posts -->
                <div class="feed-posts" id="feedPosts">
                    <!-- Posts will be loaded here -->
                </div>
                <div style="padding: 14px 18px; display:flex; justify-content:center;">
                    <button class="comment-button" id="loadMoreBtn" onclick="loadMoreFeed()">Load more</button>
                </div>
            </div>
            
            <!-- Profile Page -->
            <div id="profilePage" style="display: none;">
                <div class="feed-header">
                    <h1 class="feed-title">Profile</h1>
                </div>
                
                <div style="padding: 0;">
                    <!-- Profile Header with Banner -->
                    <div style="position: relative;">
                        <!-- Banner Image -->
                        <div id="profileBanner" style="height: 200px; background: linear-gradient(135deg, var(--terminal-green), var(--primary-gold)); border-radius: 0; position: relative; cursor: pointer; overflow: hidden;" onclick="editBanner()">
                            <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.6); padding: 8px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                Edit Banner
                            </div>
                        </div>
                        
                        <!-- Profile Avatar -->
                        <div style="position: absolute; bottom: -40px; left: 20px;">
                            <div style="position: relative;">
                                <div class="user-avatar" id="profileAvatar" style="width: 120px; height: 120px; font-size: 3rem; border: 4px solid var(--dark-blue); cursor: pointer;" onclick="editProfilePhoto()">ðŸ´â€â˜ ï¸</div>
                                <div style="position: absolute; bottom: 5px; right: 5px; background: var(--terminal-green); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid var(--dark-blue);" onclick="editProfilePhoto()">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Edit Profile Button -->
                        <div style="position: absolute; top: 210px; right: 20px;">
                            <button onclick="toggleEditProfile()" style="background: transparent; border: 1px solid var(--terminal-green); color: var(--terminal-green); padding: 10px 20px; border-radius: 20px; font-family: 'Orbitron', sans-serif; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
                                Edit Profile
                            </button>
                        </div>
                    </div>
                    
                    <!-- Profile Info -->
                    <div style="padding: 60px 20px 20px 20px;">
                        <div>
                            <h2 id="profilePirateName" style="color: var(--primary-gold); font-size: 1.5rem; margin-bottom: 5px;"></h2>
                            <p id="profileUsername" style="color: var(--text-white); opacity: 0.7; margin-bottom: 15px;"></p>
                            <p id="profileBio" style="color: var(--text-white); line-height: 1.6; margin-bottom: 20px;"></p>
                        </div>
                        
                        <!-- Profile Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; margin-bottom: 30px;">
                            <div style="text-align: center; padding: 15px; background: rgba(220, 20, 60, 0.1); border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer;" onclick="showFollowers()">
                                <div style="font-size: 1.5rem; color: var(--terminal-green); font-weight: 700;" id="profileFollowersCount">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.7;">Followers</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(220, 20, 60, 0.1); border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer;" onclick="showFollowing()">
                                <div style="font-size: 1.5rem; color: var(--accent-red); font-weight: 700;" id="profileFollowingCount">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.7;">Following</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(220, 20, 60, 0.1); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.5rem; color: var(--primary-gold); font-weight: 700;" id="profilePostCount">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.7;">Posts</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(220, 20, 60, 0.1); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.5rem; color: #00ff41; font-weight: 700;" id="profileLikeCount">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.7;">Likes</div>
                            </div>
                        </div>
                        
                        <!-- Edit Profile Form (Hidden by default) -->
                        <div id="editProfileForm" style="display: none; background: rgba(220, 20, 60, 0.1); border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="color: var(--primary-gold); margin-bottom: 20px;">Edit Profile</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-white); margin-bottom: 8px; font-size: 0.9rem;">Bio</label>
                                <textarea id="editBioTextarea" maxlength="160" style="width: 100%; background: rgba(220, 20, 60, 0.1); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; color: var(--text-white); font-family: 'Orbitron', sans-serif; min-height: 80px; resize: vertical;" placeholder="Tell us about yourself..."></textarea>
                                <div style="text-align: right; font-size: 0.8rem; opacity: 0.6; margin-top: 5px;">
                                    <span id="bioCharCount">0</span>/160
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button onclick="saveProfile()" style="flex: 1; background: linear-gradient(135deg, var(--terminal-green), var(--accent-red)); border: none; padding: 12px; border-radius: 8px; color: white; font-family: 'Orbitron', sans-serif; font-weight: 700; cursor: pointer;">
                                    Save Changes
                                </button>
                                <button onclick="cancelEditProfile()" style="flex: 1; background: transparent; border: 1px solid var(--border-color); padding: 12px; border-radius: 8px; color: var(--text-white); font-family: 'Orbitron', sans-serif; cursor: pointer;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    
                        <!-- User's Posts -->
                        <div>
                            <h3 style="color: var(--primary-gold); margin-bottom: 15px; font-size: 1.2rem;">Your Posts</h3>
                            <div class="feed-posts" id="profilePosts">
                                <!-- User posts will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden file inputs -->
                <input type="file" id="bannerInput" accept="image/*" style="display: none;" onchange="handleBannerUpload(event)">
                <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="handleProfilePhotoUpload(event)">
            </div>
            
            <!-- Trending Page -->
            <div id="trendingPage" style="display: none;">
                <div class="feed-header">
                    <h1 class="feed-title">ðŸ”¥ Trending</h1>
                </div>
                <div style="padding: 40px; text-align: center; color: var(--text-white); opacity: 0.5;">
                    Coming soon! ðŸ´â€â˜ ï¸
                </div>
            </div>
            
            <!-- Search Page -->
            <div id="searchPage" style="display: none;">
                <div class="feed-header">
                    <h1 class="feed-title">ðŸ” Search</h1>
                </div>
                
                <!-- Search Box -->
                <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search users and posts..." 
                            style="
                                width: 100%;
                                padding: 15px 50px 15px 20px;
                                background: rgba(220, 20, 60, 0.05);
                                border: 2px solid var(--border-color);
                                border-radius: 30px;
                                color: var(--text-white);
                                font-family: 'Orbitron', sans-serif;
                                font-size: 1rem;
                                outline: none;
                                transition: all 0.3s ease;
                            "
                            onkeyup="handleSearch(event)"
                        >
                        <svg 
                            style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); pointer-events: none;" 
                            width="20" 
                            height="20" 
                            viewBox="0 0 24 24" 
                            fill="none" 
                            stroke="var(--terminal-green)" 
                            stroke-width="2"
                        >
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </div>
                    
                    <!-- Search Tabs --
            </div>

                <div id="notificationsList">
                    <div style="text-align: center; color: var(--text-white); opacity: 0.5; padding: 40px;">
                        No notifications yet.
                    </div>
                </div>
            </div>

>
                    <div style="display: flex; gap: 20px; margin-top: 20px; border-bottom: 1px solid var(--border-color);">
                        <button 
                            class="search-tab active" 
                            id="searchTabAll" 
                            onclick="switchSearchTab('all')"
                            style="
                                background: transparent;
                                border: none;
                                color: var(--text-white);
                                font-family: 'Orbitron', sans-serif;
                                font-size: 0.95rem;
                                padding: 10px 20px;
                                cursor: pointer;
                                border-bottom: 3px solid transparent;
                                transition: all 0.3s ease;
                            "
                        >All</button>
                        <button 
                            class="search-tab" 
                            id="searchTabUsers" 
                            onclick="switchSearchTab('users')"
                            style="
                                background: transparent;
                                border: none;
                                color: var(--text-white);
                                font-family: 'Orbitron', sans-serif;
                                font-size: 0.95rem;
                                padding: 10px 20px;
                                cursor: pointer;
                                border-bottom: 3px solid transparent;
                                transition: all 0.3s ease;
                            "
                        >Users</button>
                        <button 
                            class="search-tab" 
                            id="searchTabPosts" 
                            onclick="switchSearchTab('posts')"
                            style="
                                background: transparent;
                                border: none;
                                color: var(--text-white);
                                font-family: 'Orbitron', sans-serif;
                                font-size: 0.95rem;
                                padding: 10px 20px;
                                cursor: pointer;
                                border-bottom: 3px solid transparent;
                                transition: all 0.3s ease;
                            "
                        >Posts</button>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div id="searchResults" style="padding: 20px;">
                    <div style="text-align: center; color: var(--text-white); opacity: 0.5; padding: 40px;">
                        Type to search for users and posts ðŸ´â€â˜ ï¸
                    </div>
                </div>
            </div>
            
            <!-- Notifications Page -->
            <div id="notificationsPage" style="display: none; padding-bottom: 24px; min-height: 60vh;">
                <div style="padding: 0 0 10px 0; opacity: .65; color: var(--text-white); font-size: 13px;">If this area is empty but the badge shows a number, open DevTools Console (F12) and look for "renderNotifications".</div>
                <div class="feed-header" style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                    <h1 class="feed-title">ðŸ”” Notifications</h1>
                    <div class="notifications-header-actions">
                        <button class="mark-read-btn" onclick="markAllNotificationsRead()">Mark all as read</button>
                    </div>
                </div>

                <div id="notificationsList" style="padding: 10px 0;"></div>
            </div>

            <!-- Settings Page -->
            <div id="settingsPage" style="display: none;">
                <div class="feed-header">
                    <h1 class="feed-title">âš™ï¸ Settings</h1>
                </div>
                <div style="padding: 40px; text-align: center; color: var(--text-white); opacity: 0.5;">
                    Coming soon! ðŸ´â€â˜ ï¸
                </div>
            </div>
            
            <!-- User Profile Page (Other Users) -->
            <div id="userProfilePage" style="display: none;">
                <div class="feed-header" style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="closeUserProfile()" style="background: transparent; border: none; color: var(--primary-gold); cursor: pointer; font-size: 1.5rem; padding: 0;">â†</button>
                    <h1 class="feed-title" id="userProfileTitle">Profile</h1>
                </div>
                
                <div style="padding: 0;">
                    <!-- Profile Header with Banner -->
                    <div style="position: relative;">
                        <!-- Banner Image -->
                        <div id="userProfileBanner" style="height: 200px; background: linear-gradient(135deg, var(--terminal-green), var(--primary-gold)); border-radius: 0; position: relative; overflow: hidden;">
                        </div>
                        
                        <!-- Profile Avatar -->
                        <div style="position: absolute; bottom: -40px; left: 20px;">
                            <div class="user-avatar" id="userProfileAvatar" style="width: 120px; height: 120px; font-size: 3rem; border: 4px solid var(--dark-blue);">ðŸ´â€â˜ ï¸</div>
                        </div>
                        
                        <!-- Follow Button -->
                        <div style="position: absolute; top: 210px; right: 20px;">
                            <button id="userProfileFollowBtn" onclick="toggleUserProfileFollow()" class="follow-btn" style="padding: 10px 30px; font-size: 0.9rem;">
                                Follow
                            </button>
                        </div>
                    </div>
                    
                    <!-- Profile Info -->
                    <div style="padding: 60px 20px 20px 20px;">
                        <div>
                            <h2 id="userProfilePirateName" style="color: var(--primary-gold); font-size: 1.5rem; margin-bottom: 5px;"></h2>
                            <p id="userProfileUsername" style="color: var(--text-white); opacity: 0.7; margin-bottom: 15px;"></p>
                            <p id="userProfileBio" style="color: var(--text-white); line-height: 1.6; margin-bottom: 20px;"></p>
                        </div>
                        
                        <!-- Profile Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; margin-bottom: 30px;">
                            <div style="text-align: center; padding: 15px; background: rgba(220, 20, 60, 0.1); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.5rem; color: var(--terminal-green); font-weight: 700;" id="userProfileFollowersCount">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.7;">Followers</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(220, 20, 60, 0.1); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.5rem; color: var(--accent-red); font-weight: 700;" id="userProfileFollowingCount">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.7;">Following</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(220, 20, 60, 0.1); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.5rem; color: var(--primary-gold); font-weight: 700;" id="userProfilePostCount">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.7;">Posts</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(220, 20, 60, 0.1); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-size: 1.5rem; color: #00ff41; font-weight: 700;" id="userProfileLikeCount">0</div>
                                <div style="font-size: 0.85rem; opacity: 0.7;">Likes</div>
                            </div>
                        </div>
                        
                        <!-- User's Posts -->
                        <div>
                            <h3 style="color: var(--primary-gold); margin-bottom: 15px; font-size: 1.2rem;">Posts</h3>
                            <div class="feed-posts" id="userProfilePosts">
                                <!-- User posts will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Right Sidebar -->
        <aside class="right-sidebar">
            <div class="trending-section">
                <h2 class="section-title">ðŸ”¥ Trending</h2>
                <div id="trendingLoading" style="opacity:.7; padding: 10px 0;">Loading trendingâ€¦</div>
                <div id="trendingList"></div>

                <div class="trending-note" style="opacity:.55; font-size:.9rem; margin-top:10px;">
                    Based on hashtags in recent posts.
                </div>

                <h2 class="section-title">ðŸ‘¥ Who to Follow</h2>
                <div id="whoToFollowList">
                    <!-- Users will be loaded dynamically -->
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Comment Modal -->
    <div class="comment-modal" id="commentModal">
        <div class="comment-modal-content">
            <div class="comment-modal-header">
                <h2 class="comment-modal-title">ðŸ’¬ Comments</h2>
                <button class="close-modal" onclick="closeCommentModal()">âœ•</button>
            </div>
            
            <div class="original-post" id="modalOriginalPost">
                <!-- Original post will be shown here -->
            </div>
            
            <div class="comment-input-section">
                <textarea 
                    class="comment-textarea" 
                    id="commentTextarea" 
                    placeholder="Write your comment..."
                    maxlength="280"
                ></textarea>
                
                <!-- Comment Image Preview -->
                <div class="image-preview" id="commentImagePreview">
                    <img id="commentPreviewImg" class="preview-image" alt="Preview">
                    <button class="remove-image" onclick="removeCommentImage()">âœ•</button>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <div class="post-icons">
                        <input type="file" id="commentImageInput" accept="image/*" style="display: none;" onchange="handleCommentImageSelect(event)">
                        <span class="post-icon" title="Add image" onclick="document.getElementById('commentImageInput').click()" style="cursor: pointer;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </span>
                    </div>
                    <button class="comment-button" onclick="postComment()">Comment</button>
                </div>
                <div style="clear: both;"></div>
            </div>
            
            <div class="comments-list" id="commentsList">
                <!-- Comments will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Followers/Following Modal -->
    <div class="followers-modal" id="followersModal">
        <div class="followers-modal-content">
            <div class="followers-modal-header">
                <h2 class="followers-modal-title" id="followersModalTitle">ðŸ‘¥ Followers</h2>
                <button class="followers-modal-close" onclick="closeFollowersModal()">âœ•</button>
            </div>
            
            <div class="followers-modal-list" id="followersModalList">
                <!-- Followers/Following list will be loaded here -->
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let FEED_LIMIT = 50;
        const renderedPostIds = new Set();
        let lastFeedPosts = [];
        let feedUnsub = null;

        function safeSetDisplay(id, value) {
            const el = document.getElementById(id);
            if (el) el.style.display = value;
        }


        // -----------------------------
        // Notifications (Realtime DB)
        // -----------------------------
        let notificationsState = {
            items: [],       // newest first
            unreadCount: 0,
            map: {},         // id -> item
        };
        

        // --- Overlay avatar hydration (v26) ---
        const notifAvatarCache = new Map(); // userId -> avatarUrl (profilePhoto)
        const notifAvatarPending = new Set();

        function getAvatarUrlFromUserData(data) {
            if (!data) return '';
            return data.profilePhoto || data.profilePic || data.avatarUrl || data.photoURL || '';
        }

        async function fetchAvatarForUser(userId) {
            if (!userId) return '';
            if (notifAvatarCache.has(userId)) return notifAvatarCache.get(userId);
            if (notifAvatarPending.has(userId)) return '';

            notifAvatarPending.add(userId);
            try {
                const uref = window.firebaseRef(window.firebaseDB, `users/${userId}`);
                const snap = await window.firebaseGet(uref);
                const data = snap.exists() ? snap.val() : null;
                const url = getAvatarUrlFromUserData(data);
                notifAvatarCache.set(userId, url || '');
                return url || '';
            } catch (e) {
                console.warn('fetchAvatarForUser failed:', e);
                return '';
            } finally {
                notifAvatarPending.delete(userId);
            }
        }

        function hydrateOverlayAvatars() {
            const imgs = document.querySelectorAll('#notificationsOverlayList img[data-actor-id]');
            const ids = Array.from(new Set(Array.from(imgs).map(img => img.getAttribute('data-actor-id')).filter(Boolean)));
            ids.forEach(async (id) => {
                const url = await fetchAvatarForUser(id);
                if (!url) return;
                document.querySelectorAll(`#notificationsOverlayList img[data-actor-id="${id}"]`).forEach(img => {
                    if (!img.getAttribute('src')) img.setAttribute('src', url);
                });
            });
        }
        // --- End avatar hydration (v26) ---

let notificationsUnsub = null;

        function formatTimeAgo(ts) {
            if (!ts) return '';
            const diff = Date.now() - ts;
            const s = Math.floor(diff / 1000);
            if (s < 60) return `${s}s`;
            const m = Math.floor(s / 60);
            if (m < 60) return `${m}m`;
            const h = Math.floor(m / 60);
            if (h < 24) return `${h}h`;
            const d = Math.floor(h / 24);
            return `${d}d`;
        }

        function buildNotificationText(n) {
            const who = n.actorPirateName || n.actorUsername || 'Someone';
            
                const cached = notifUserCache.get(n.actorId) || null;
                const avatarUrl = (cached && cached.avatarUrl) ? cached.avatarUrl : '';
                const cachedPirate = cached && cached.pirateName ? cached.pirateName : '';
                const cachedUser = cached && cached.username ? cached.username : '';
if (n.type === 'like') return `${who} liked your post`;
            if (n.type === 'comment') return `${who} commented on your post`;
            if (n.type === 'retweet') return `${who} reposted your post`;
            if (n.type === 'follow') return `${who} followed you`;
            return `${who} sent a notification`;
        }

        async function createNotification(targetUserId, type, payload = {}) {
            if (!currentUser) return false;
            if (!targetUserId) return false;

            // Don't notify yourself
            if (targetUserId === currentUser.userId) return false;

            try {
                const notifRef = window.firebaseRef(window.firebaseDB, `notifications/${targetUserId}`);
                const newRef = window.firebasePush(notifRef);

                const notif = {
                    type,
                    actorId: currentUser.userId,
                    actorUsername: currentUser.username || '',
                    actorPirateName: currentUser.pirateName || '',
                    createdAt: Date.now(),
                    read: false,
                    ...payload
                };

                await window.firebaseSet(newRef, notif);
                console.log('ðŸ”” Notification created:', { targetUserId, type, payload });
                return true;
            } catch (e) {
                console.error('createNotification error:', e);

                // Surface common permission problems
                const msg = (e && (e.message || e.toString())) || '';
                if (msg.toLowerCase().includes('permission') || msg.toLowerCase().includes('denied')) {
                    console.warn('âš ï¸ Notifications write blocked by Realtime Database Rules. You need to allow writes to /notifications.');
                }
                return false;
            }
        }

        function updateNotificationsBadge() {
            const badge = document.getElementById('notificationsBadge');
            if (!badge) return;
            if (notificationsState.unreadCount > 0) {
                badge.style.display = 'inline-block';
                badge.textContent = notificationsState.unreadCount > 99 ? '99+' : String(notificationsState.unreadCount);
            } else {
                badge.style.display = 'none';
            }
        }

        let notifUnsub = null;

        function startNotificationListener() {
            try { if (notifUnsub) { notifUnsub(); notifUnsub = null; } } catch(e) {}
            try {
                if (!currentUser) return;

                // Cleanup previous listener
                if (typeof notificationsUnsub === 'function') {
                    try { notificationsUnsub(); } catch (_) {}
                }
                notificationsUnsub = null;

                const baseRef = window.firebaseRef(window.firebaseDB, `notifications/${currentUser.userId}`);
                const q = window.firebaseQuery(baseRef, window.firebaseOrderByChild('createdAt'), window.firebaseLimitToLast(FEED_LIMIT));

                notificationsUnsub = window.firebaseOnValue(q, (snap) => {
                    const val = snap.exists() ? snap.val() : {};
                    const items = [];
                    const map = {};

                    Object.entries(val).forEach(([id, n]) => {
                        if (!n) return;
                        const item = { id, ...n };
                        map[id] = item;
                        items.push(item);
                    });

                    items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    const unread = items.reduce((acc, n) => acc + (n.read ? 0 : 1), 0);

                    notificationsState = { items, unreadCount: unread, map };
                    updateNotificationsBadge();

                    // If notifications page is open, re-render
                    const pageEl = document.getElementById('notificationsPage');
                    if (pageEl && pageEl.style.display !== 'none') {
                    }
                });
            } catch (e) {
                console.error('startNotificationListener error:', e);
            }
        }

        async function markNotificationRead(notificationId) {
            try {
                if (!currentUser) return;
                const ref = window.firebaseRef(window.firebaseDB, `notifications/${currentUser.userId}/${notificationId}/read`);
                await window.firebaseSet(ref, true);
            } catch (e) {
                console.error('markNotificationRead error:', e);
            }
        }

        async function markAllNotificationsRead() {
            try {
                if (!currentUser) return;
                const updates = notificationsState.items.filter(n => !n.read);
                await Promise.all(updates.map(n => markNotificationRead(n.id)));
            } catch (e) {
                console.error('markAllNotificationsRead error:', e);
            }
        }

        function openNotification(notificationId) {
            const n = notificationsState.map[notificationId];
            if (!n) return;

            // Mark as read (async)
            markNotificationRead(notificationId);

            // If related to a post, go to Home and scroll to it
            if (n.postId) {
                switchPage('home');
                // wait a bit for feed render
                setTimeout(() => {
                    const el = document.querySelector(`[data-post-id="${n.postId}"]`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 600);
            }
        }

        function renderNotifications() {
            const list = document.getElementById('notificationsList');
            const overlayList = document.getElementById('notificationsOverlayList');
            if (!list && !overlayList) { console.warn('notificationsList not found'); return; }

            if (!notificationsState.items.length) {
                const emptyHtml = `
                    <div style="text-align: center; color: var(--text-white); opacity: 0.5; padding: 40px;">
                        No notifications yet.
                    </div>
                `;
                if (list) list.innerHTML = emptyHtml;
                if (overlayList) overlayList.innerHTML = emptyHtml;
                return;
            }

            const htmlStr = notificationsState.items.map(n => {
                const pirateName = escapeHtml(n.actorPirateName || '');
                const handle = escapeHtml(n.actorUsername || '');
                const who = pirateName || cachedPirate || handle || cachedUser || 'Someone';

                const time = formatTimeAgo(n.createdAt);
                const unreadClass = n.read ? '' : 'notif-unread';

                const icon = (n.type === 'follow') ? 'ðŸ‘¤'
                           : (n.type === 'retweet') ? 'ðŸ”'
                           : (n.type === 'comment') ? 'ðŸ’¬'
                           : 'â¤ï¸';

                const actionText = (n.type === 'follow') ? 'followed you'
                                 : (n.type === 'retweet') ? 'reposted your post'
                                 : (n.type === 'comment') ? 'commented on your post'
                                 : 'liked your post';

                // Prefer showing post snippet; for comments also show comment snippet first
                let snippet = '';
                if (n.type === 'comment' && n.commentSnippet) {
                    snippet = n.commentSnippet;
                } else if (n.postSnippet) {
                    snippet = n.postSnippet;
                }

                const snippetHtml = snippet
                    ? `<div class="notif-snippet">â€œ${escapeHtml(snippet)}â€</div>`
                    : '';

                const nameHtml = pirateName
                    ? `<span class="notif-name">${pirateName}</span>`
                    : `<span class="notif-name">${escapeHtml(who)}</span>`;

                const handleHtml = handle
                    ? `<span class="notif-handle">@${handle}</span>`
                    : '';

                return `
                    <div class="notif-row ${unreadClass}" onclick="openNotification('${n.id}')">
                        <div class="notif-lefticon">${icon}</div>
                        <div class="notif-avatar" aria-hidden="true">
                            ${avatarUrl ? `<img class="notif-avatar-img" src="${escapeHtml(avatarUrl)}" alt="" />` : `<div class="notif-avatar-inner">${escapeHtml((who || 'U').slice(0,1).toUpperCase())}</div>`}
                        </div>
                        <div class="notif-body">
                            <div class="notif-topline">
                                ${nameHtml}
                                ${handleHtml}
                                <span class="notif-dot">Â·</span>
                                <span class="notif-time">${escapeHtml(time)}</span>
                            </div>
                            <div class="notif-action">${escapeHtml(actionText)}</div>
                            ${snippetHtml}
                        </div>
                    </div>
                `;
            }).join('');

            if (list) list.innerHTML = htmlStr;
            if (overlayList) overlayList.innerHTML = htmlStr;
        }

        
        // Wait for Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                const check = setInterval(() => {
                    if (window.firebaseReady) {
                        clearInterval(check);
                        resolve();
                    }
                }, 100);
            });
        }
        
        // Initialize
        waitForFirebase().then(async () => {
            const saved = localStorage.getItem('compass_user');
            if (saved) {
                try {
                    currentUser = JSON.parse(saved);
                    
                    // Load fresh profile data from Firebase
                    try {
                        const userRef = window.firebaseRef(window.firebaseDB, 'users/' + currentUser.userId);
                        const userSnap = await window.firebaseGet(userRef);
                        
                        if (userSnap.exists()) {
                            const userData = userSnap.val();
                            // Update current user with latest profile data
                            if (userData.profilePhoto) {
                                currentUser.profilePhoto = userData.profilePhoto;
                            }
                            if (userData.banner) {
                                currentUser.banner = userData.banner;
                            }
                            if (userData.bio) {
                                currentUser.bio = userData.bio;
                            }
                            // Save updated user to localStorage
                            localStorage.setItem('compass_user', JSON.stringify(currentUser));
                        }
                    } catch (e) {
                        console.error('Error loading profile data:', e);
                    }
                    
                    loadUserInterface();
                    hideAuthModal();
                    loadFeed();
                    initInfiniteScroll();
                } catch (e) {
                    showAuthModal();
                }
            } else {
                showAuthModal();
            }
        });
        
        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
        }
        
        function hideAuthModal() {
            document.getElementById('authModal').classList.add('hidden');
        }
        
        // Auth forms
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const authSwitchLink = document.getElementById('authSwitchLink');
        const authSwitchText = document.getElementById('authSwitchText');
        const authError = document.getElementById('authError');
        const authSuccess = document.getElementById('authSuccess');
        
        let isLoginMode = true;
        
        authSwitchLink.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                loginForm.style.display = 'flex';
                registerForm.style.display = 'none';
                authSwitchText.textContent = "Don't have an account?";
                authSwitchLink.textContent = "Join the crew";
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'flex';
                authSwitchText.textContent = "Already a crew member?";
                authSwitchLink.textContent = "Set sail";
            }
            authError.classList.remove('show');
            authSuccess.classList.remove('show');
        });
        
        // Register
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const submitBtn = registerForm.querySelector('.auth-button');
            
            console.log('ðŸš€ Registration started for:', username);
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            
            try {
                console.log('ðŸ“¡ Checking if username exists...');
                const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const exists = Object.values(users).some(u => u.username === username);
                    if (exists) {
                        console.log('âŒ Username already taken');
                        showAuthError('Username taken');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'âš“ Join Crew';
                        return;
                    }
                }
                
                console.log('âœ… Username available');
                console.log('ðŸ”¢ Getting pirate number...');
                
                const counterRef = window.firebaseRef(window.firebaseDB, 'pirateCounter');
                const counterSnap = await window.firebaseGet(counterRef);
                const pirateNumber = counterSnap.exists() ? counterSnap.val() + 1 : 1;
                const pirateName = 'pirate' + pirateNumber;
                
                console.log('ðŸ´â€â˜ ï¸ Pirate name:', pirateName);
                
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const passwordHash = btoa(password);
                
                const userRef = window.firebaseRef(window.firebaseDB, 'users/' + userId);
                const userData = {
                    username: username,
                    passwordHash: passwordHash,
                    pirateName: pirateName,
                    pirateNumber: pirateNumber,
                    createdAt: Date.now()
                };
                
                console.log('ðŸ’¾ Saving user to database...');
                await window.firebaseSet(userRef, userData);
                await window.firebaseSet(counterRef, pirateNumber);
                console.log('âœ… User created successfully!');
                
                currentUser = { ...userData, userId: userId };
                delete currentUser.passwordHash;
                localStorage.setItem('compass_user', JSON.stringify(currentUser));
                
                showAuthSuccess('Welcome, ' + pirateName + '! ðŸ´â€â˜ ï¸');
                
                setTimeout(() => {
                    hideAuthModal();
                    loadUserInterface();
                    loadFeed();
                }, 1500);
                
            } catch (error) {
                console.error('âŒ Registration error:', error);
                showAuthError('Registration failed: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âš“ Join Crew';
            }
        });
        
        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const submitBtn = loginForm.querySelector('.auth-button');
            
            console.log('ðŸ” Login started for:', username);
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';
            
            try {
                console.log('ðŸ“¡ Fetching users from database...');
                const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (!snapshot.exists()) {
                    console.log('âŒ No users in database');
                    showAuthError('Invalid credentials');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'âš“ Set Sail';
                    return;
                }
                
                console.log('âœ… Users found, searching for username...');
                const users = snapshot.val();
                let foundUser = null;
                let foundUserId = null;
                
                for (const [userId, userData] of Object.entries(users)) {
                    if (userData.username === username) {
                        foundUser = userData;
                        foundUserId = userId;
                        break;
                    }
                }
                
                if (!foundUser) {
                    console.log('âŒ Username not found');
                    showAuthError('Invalid credentials');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'âš“ Set Sail';
                    return;
                }
                
                console.log('âœ… User found, checking password...');
                const passwordHash = btoa(password);
                if (foundUser.passwordHash !== passwordHash) {
                    console.log('âŒ Wrong password');
                    showAuthError('Invalid credentials');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'âš“ Set Sail';
                    return;
                }
                
                console.log('âœ… Login successful!');
                currentUser = { ...foundUser, userId: foundUserId };
                delete currentUser.passwordHash;
                localStorage.setItem('compass_user', JSON.stringify(currentUser));
                
                showAuthSuccess('Welcome back, ' + currentUser.pirateName + '! âš“');
                
                setTimeout(() => {
                    hideAuthModal();
                    loadUserInterface();
                    loadFeed();
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Login error:', error);
                showAuthError('Login failed: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âš“ Set Sail';
            }
        });
        
        function loadUserInterface() {
            if (!currentUser) return;
            
            document.getElementById('sidebarUserName').textContent = currentUser.pirateName;
            document.getElementById('sidebarUserHandle').textContent = '@' + currentUser.username;
            document.getElementById('sidebarUserInfo').style.display = 'block';
            
            const avatar = document.getElementById('postAvatar');
            if (currentUser.profilePhoto) {
                avatar.innerHTML = `<img src="${currentUser.profilePhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else {
                avatar.textContent = currentUser.pirateName.charAt(0).toUpperCase();
            }
            
            // Load who to follow
            loadWhoToFollow();
            // Start notifications listener (after login)
            startNotificationListener();
                    startTrendingListener();

        }
        function logout() {
            try { if (trendingUnsub) { trendingUnsub(); trendingUnsub = null; } } catch(e) {}
            try { if (notifUnsub) { notifUnsub(); notifUnsub = null; } } catch(e) {}
            try { if (commentsUnsub) { commentsUnsub(); commentsUnsub = null; } } catch(e) {}
currentUser = null;
            localStorage.removeItem('compass_user');
            showAuthModal();
            document.getElementById('sidebarUserInfo').style.display = 'none';
            document.getElementById('feedPosts').innerHTML = '';
        
            // Stop notifications listener
            if (typeof notificationsUnsub === 'function') {
                try { notificationsUnsub(); } catch (_) {}
            }
            notificationsUnsub = null;
        }
        
        function showAuthError(msg) {
            authError.textContent = msg;
            authError.classList.add('show');
            authSuccess.classList.remove('show');
            setTimeout(() => authError.classList.remove('show'), 5000);
        }
        
        function showAuthSuccess(msg) {
            authSuccess.textContent = msg;
            authSuccess.classList.add('show');
            authError.classList.remove('show');
        }
        
        // === POST FUNCTIONS ===
        let selectedImage = null;
        
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('Image too large! Max 2MB');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImage = e.target.result;
                document.getElementById('previewImg').src = selectedImage;
                document.getElementById('imagePreview').classList.add('active');
            };
            reader.readAsDataURL(file);
        }
        
        function removeImage() {
            selectedImage = null;
            document.getElementById('imagePreview').classList.remove('active');
            document.getElementById('imageInput').value = '';
        }
        
        async function createPost() {
            const textarea = document.getElementById('postTextarea');
            const text = textarea.value.trim();
            
            if (!text && !selectedImage) return;
            if (!currentUser) return;
            
            const postButton = document.getElementById('postButton');
            postButton.disabled = true;
            postButton.textContent = 'Posting...';
            
            try {
                const postsRef = window.firebaseRef(window.firebaseDB, 'posts');
                const postData = {
                    userId: currentUser.userId,
                    username: currentUser.username,
                    pirateName: currentUser.pirateName,
                    text: text,
                    timestamp: Date.now(),
                    likes: 0,
                    comments: 0,
                    reposts: 0,
                    views: 0
                };
                
                // Add image if selected
                if (selectedImage) {
                    postData.image = selectedImage;
                }
                
                await window.firebasePush(postsRef, postData);
                
                textarea.value = '';
                removeImage();
                console.log('âœ… Post created');
                
            } catch (e) {
                console.error('Post error:', e);
                alert('Error posting. Image might be too large.');
            } finally {
                postButton.disabled = false;
                postButton.textContent = 'Post';
            }
        }
        
        async function loadFeed() {
            if (!currentUser) return;
            
            try {
                const postsQuery = window.firebaseQuery(
                    window.firebaseRef(window.firebaseDB, 'posts'),
                    window.firebaseOrderByChild('timestamp'),
                    window.firebaseLimitToLast(50)
                );
                
                // Use real-time listener
                window.firebaseOnValue(postsQuery, async (snapshot) => {
                    let allPosts = [];
                    
                    // Load regular posts
                    snapshot.forEach(s => {
                        const post = { id: s.key, ...s.val() };
                        allPosts.push({
                            ...post,
                            timestamp: post.timestamp,
                            isRetweet: false
                        });
                    });
                    
                    // Load retweets from followed users
                    const followsRef = window.firebaseRef(window.firebaseDB, 'follows/' + currentUser.userId);
                    const followsSnap = await window.firebaseGet(followsRef);
                    
                    if (followsSnap.exists()) {
                        const follows = followsSnap.val();
                        
                        for (const followedUserId in follows) {
                            const userRetweetsRef = window.firebaseRef(window.firebaseDB, 'userRetweets/' + followedUserId);
                            const userRetweetsSnap = await window.firebaseGet(userRetweetsRef);
                            
                            if (userRetweetsSnap.exists()) {
                                const retweets = userRetweetsSnap.val();
                                
                                // Get retweeter's name
                                const retweeterRef = window.firebaseRef(window.firebaseDB, 'users/' + followedUserId);
                                const retweeterSnap = await window.firebaseGet(retweeterRef);
                                const retweeterName = retweeterSnap.exists() ? retweeterSnap.val().pirateName : 'User';
                                
                                for (const postId in retweets) {
                                    const retweetData = retweets[postId];
                                    const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + postId);
                                    const postSnap = await window.firebaseGet(postRef);
                                    
                                    if (postSnap.exists()) {
                                        const originalPost = { id: postSnap.key, ...postSnap.val() };
                                        allPosts.push({
                                            ...originalPost,
                                            timestamp: retweetData.retweetTimestamp,
                                            isRetweet: true,
                                            retweeterName: retweeterName
                                        });
                                    }
                                }
                            }
                        }
                    }
                    
                    // Sort all posts by timestamp
                    allPosts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Check like and retweet status
                    for (let post of allPosts) {
                        const likeRef = window.firebaseRef(window.firebaseDB, 'likes/' + post.id + '/' + currentUser.userId);
                        const likeSnap = await window.firebaseGet(likeRef);
                        post.likedByCurrentUser = likeSnap.exists();
                        
                        const retweetRef = window.firebaseRef(window.firebaseDB, 'retweets/' + post.id + '/' + currentUser.userId);
                        const retweetSnap = await window.firebaseGet(retweetRef);
                        post.retweetedByCurrentUser = retweetSnap.exists();
                    }
                    
                    displayPosts(allPosts);
                });
                
            } catch (e) {
                console.error('Feed load error:', e);
            }
        }
        
        function displayPosts(posts) {
            const feedPosts = document.getElementById('feedPosts');
            feedPosts.innerHTML = '';
            
            if (posts.length === 0) {
                feedPosts.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-white); opacity: 0.5;">No posts yet. Be the first to post! ðŸ´â€â˜ ï¸</div>';
                return;
            }
            
            posts.forEach(post => {
                const postEl = createPostElement(post, post.isRetweet, post.retweeterName);
                feedPosts.appendChild(postEl);
            });
        }
        
        function createPostElement(post, isRetweet = false, retweeterName = null) {
            const div = document.createElement('div');
            div.className = 'post';
            div.dataset.postId = post.id;
            
            // Increment view when post is created (displayed)
            incrementPostView(post.id);
            
            const timeAgo = getTimeAgo(post.timestamp);
            
            // Image HTML if exists
            const imageHtml = post.image ? `<img src="${post.image}" class="post-image" loading="lazy" alt="Post image" onclick="openImageModal('${post.image}')">` : '';
            
            // Create avatar HTML - DIRECTLY, not async
            const avatarId = 'avatar-' + post.id + '-' + Math.random().toString(36).substr(2, 9);
            let avatarHtml = '';
            
            // If it's current user's post, use the locally stored photo
            if (currentUser && post.userId === currentUser.userId && currentUser.profilePhoto) {
                avatarHtml = `<img src="${currentUser.profilePhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else {
                // For other users or if no photo, use first letter
                avatarHtml = post.pirateName.charAt(0).toUpperCase();
            }
            
            // Show delete button only for own posts
            const isOwnPost = currentUser && post.userId === currentUser.userId;
            const menuHtml = isOwnPost ? `
                <div class="post-menu-btn" onclick="togglePostMenu(event, '${post.id}')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="12" cy="5" r="2"></circle>
                        <circle cx="12" cy="12" r="2"></circle>
                        <circle cx="12" cy="19" r="2"></circle>
                    </svg>
                </div>
                <div class="post-menu-dropdown" id="menu-${post.id}">
                    <div class="post-menu-item delete" onclick="deletePost('${post.id}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Delete
                    </div>
                </div>
            ` : '';
            
            // Retweet header if this is a retweet
            const retweetHeader = isRetweet ? `
                <div style="display: flex; align-items: center; gap: 8px; padding: 10px 15px 5px 50px; color: var(--terminal-green); font-size: 0.85rem; opacity: 0.9;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="17 1 21 5 17 9"></polyline>
                        <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                        <polyline points="7 23 3 19 7 15"></polyline>
                        <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                    </svg>
                    <span>${retweeterName} retweeted</span>
                </div>
            ` : '';
            
            div.innerHTML = `
                ${retweetHeader}
                <div class="post-header">
                    ${menuHtml}
                    <div class="user-avatar" id="${avatarId}" style="cursor: pointer;" onclick="viewUserProfile('${post.userId}')">${avatarHtml}</div>
                    <div class="post-content-area">
                        <div class="post-user-info" style="cursor: pointer;" onclick="viewUserProfile('${post.userId}')">
                            <span class="post-username">${post.pirateName}</span>
                            <span class="post-handle">@${post.username}</span>
                            <span class="post-time">Â· ${timeAgo}</span>
                        </div>
                        <div class="post-text">${linkifyText(post.text)}</div>
                        ${imageHtml}
                        <div class="post-stats">
                            <div class="post-stat post-stat-comment ${post.commentedByCurrentUser ? 'commented' : ''}" data-post-id="${post.id}" style="cursor: pointer;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                                </svg>
                                <span>${post.comments || 0}</span>
                            </div>
                            <div class="post-stat post-stat-retweet ${post.retweetedByCurrentUser ? 'retweeted' : ''}" data-post-id="${post.id}" style="cursor: pointer;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="17 1 21 5 17 9"></polyline>
                                    <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                                    <polyline points="7 23 3 19 7 15"></polyline>
                                    <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                                </svg>
                                <span>${post.reposts || 0}</span>
                            </div>
                            <div class="post-stat post-stat-like ${post.likedByCurrentUser ? 'liked' : ''}" data-post-id="${post.id}" style="cursor: pointer;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                                <span>${post.likes || 0}</span>
                            </div>
                            <div class="post-stat">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                </svg>
                                <span>${post.views || 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners programmatically
            const commentBtn = div.querySelector('.post-stat-comment');
            const retweetBtn = div.querySelector('.post-stat-retweet');
            const likeBtn = div.querySelector('.post-stat-like');
            
            if (commentBtn) {
                commentBtn.addEventListener('click', () => openCommentModal(post.id));
            }
            if (retweetBtn) {
                retweetBtn.addEventListener('click', () => retweetPost(post.id));
            }
            if (likeBtn) {
                likeBtn.addEventListener('click', () => likePost(post.id));
            }
            
            // For other users' posts, load avatar from Firebase asynchronously
            if (!currentUser || post.userId !== currentUser.userId) {
                loadUserAvatarAsync(post.userId, avatarId, post.pirateName);
            }
            
            return div;
        }
        
        // Separate async function for loading other users' avatars
        async function loadUserAvatarAsync(userId, avatarId, pirateName) {
            try {
                const userRef = window.firebaseRef(window.firebaseDB, 'users/' + userId);
                const userSnap = await window.firebaseGet(userRef);
                
                if (userSnap.exists()) {
                    const userData = userSnap.val();
                    const avatarElement = document.getElementById(avatarId);
                    
                    if (avatarElement && userData.profilePhoto) {
                        avatarElement.innerHTML = `<img src="${userData.profilePhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    }
                }
            } catch (e) {
                console.error('Error loading avatar:', e);
            }
        }
        
        async function loadUserAvatar(userId, avatarId, pirateName) {
            try {
                const avatarElement = document.getElementById(avatarId);
                if (!avatarElement) {
                    console.error('âŒ Avatar element NOT FOUND! ID:', avatarId);
                    return;
                }
                
                console.log('âœ… Avatar element FOUND! ID:', avatarId);
                
                // If it's current user's post, use the locally stored photo (most up-to-date)
                if (currentUser && userId === currentUser.userId) {
                    console.log('ðŸ” Loading OWN avatar - currentUser.profilePhoto:', currentUser.profilePhoto ? 'EXISTS' : 'NULL');
                    console.log('ðŸ“¸ CURRENT profilePhoto (first 50 chars):', currentUser.profilePhoto ? currentUser.profilePhoto.substring(0, 50) : 'N/A');
                    if (currentUser.profilePhoto) {
                        // CRITICAL FIX: Clear text content first!
                        avatarElement.textContent = '';
                        // Create img element properly
                        const img = document.createElement('img');
                        img.src = currentUser.profilePhoto;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '50%';
                        avatarElement.appendChild(img);
                        console.log('âœ… Set own avatar - Element ID:', avatarId);
                    } else {
                        avatarElement.textContent = pirateName.charAt(0).toUpperCase();
                        console.log('âš ï¸ No profilePhoto, using letter');
                    }
                    return;
                }
                
                // For other users, fetch from Firebase
                const userRef = window.firebaseRef(window.firebaseDB, 'users/' + userId);
                const userSnap = await window.firebaseGet(userRef);
                
                if (userSnap.exists()) {
                    const userData = userSnap.val();
                    
                    if (userData.profilePhoto) {
                        // CRITICAL FIX: Clear text content first!
                        avatarElement.textContent = '';
                        // Create img element properly
                        const img = document.createElement('img');
                        img.src = userData.profilePhoto;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '50%';
                        avatarElement.appendChild(img);
                    } else {
                        avatarElement.textContent = pirateName.charAt(0).toUpperCase();
                    }
                }
            } catch (e) {
                console.error('Error loading avatar:', e);
            }
        }
        
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            if (seconds < 60) return seconds + 's';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            return Math.floor(seconds / 86400) + 'd';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function likePost(postId) {
            if (!currentUser) return;
            
            try {
                const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + postId);
                const likesRef = window.firebaseRef(window.firebaseDB, 'likes/' + postId + '/' + currentUser.userId);
                
                // Check if already liked
                const likeSnap = await window.firebaseGet(likesRef);
                
                let newLikeCount;
                
                if (likeSnap.exists()) {
                    // Unlike
                    await window.firebaseSet(likesRef, null);
                    
                    // Decrease like count
                    const postSnap = await window.firebaseGet(postRef);
                    if (postSnap.exists()) {
                        const post = postSnap.val();
                        newLikeCount = Math.max(0, (post.likes || 0) - 1);
                        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'posts/' + postId + '/likes'), newLikeCount);
                    }
                } else {
                    // Like
                    await window.firebaseSet(likesRef, {
                        userId: currentUser.userId,
                        timestamp: Date.now()
                    });
                    
                    // Increase like count
                    const postSnap = await window.firebaseGet(postRef);
                    if (postSnap.exists()) {
                        const post = postSnap.val();
                        newLikeCount = (post.likes || 0) + 1;
                        // Notify post owner
                        await createNotification(post.userId, 'like', { postId: postId, postSnippet: (post.text || '').slice(0, 120) });
                        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'posts/' + postId + '/likes'), newLikeCount);
                    }
                }
                
                dlog('âœ… Like toggled, new count:', newLikeCount);
                
                // Update UI directly without reloading page
                const postElements = document.querySelectorAll(`[data-post-id="${postId}"]`);
                postElements.forEach(postEl => {
                    const likeBtn = postEl.closest('.post').querySelector('.post-stat-like span');
                    if (likeBtn) {
                        likeBtn.textContent = newLikeCount;
                    }
                });
                
            } catch (e) {
                console.error('Like error:', e);
            }
        }
        
        async function retweetPost(postId) {
            if (!currentUser) return;
            
            try {
                const retweetRef = window.firebaseRef(window.firebaseDB, 'retweets/' + postId + '/' + currentUser.userId);
                
                // Check if already retweeted
                const retweetSnap = await window.firebaseGet(retweetRef);
                
                if (retweetSnap.exists()) {
                    // UN-RETWEET: Remove the retweet
                    await window.firebaseSet(retweetRef, null);
                    
                    // Decrease retweet count
                    const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + postId);
                    const postSnap = await window.firebaseGet(postRef);
                    if (postSnap.exists()) {
                        const post = postSnap.val();
                        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'posts/' + postId + '/reposts'), Math.max(0, (post.reposts || 0) - 1));
                    }
                    
                    // Remove from user's retweet list
                    const userRetweetsRef = window.firebaseRef(window.firebaseDB, 'userRetweets/' + currentUser.userId + '/' + postId);
                    await window.firebaseSet(userRetweetsRef, null);
                    
                    console.log('âœ… Retweet removed');
                } else {
                    // RETWEET: Create new retweet
                    
                    // 1. Add to retweets table
                    await window.firebaseSet(retweetRef, {
                        userId: currentUser.userId,
                        timestamp: Date.now()
                    });
                    
                    // 2. Increase retweet count
                    const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + postId);
                    const postSnap = await window.firebaseGet(postRef);
                    if (postSnap.exists()) {
                        const post = postSnap.val();
                        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'posts/' + postId + '/reposts'), (post.reposts || 0) + 1);
                    
                        // Notify post owner
                        await createNotification(post.userId, 'retweet', { postId: postId, postSnippet: (post.text || '').slice(0, 120) });
                    }
                    
                    // 3. Add to user's retweet list (to show in profile)
                    const userRetweetsRef = window.firebaseRef(window.firebaseDB, 'userRetweets/' + currentUser.userId + '/' + postId);
                    await window.firebaseSet(userRetweetsRef, {
                        originalPostId: postId,
                        retweetTimestamp: Date.now()
                    });
                    
                    dlog('âœ… Retweeted successfully');
                }
                
                // Refresh the current page
                const currentPage = document.getElementById('homePage').style.display !== 'none' ? 'home' : 
                                  document.getElementById('profilePage').style.display !== 'none' ? 'profile' : 
                                  document.getElementById('userProfilePage').style.display !== 'none' ? 'userProfile' : null;
                
                if (currentPage === 'home') {
                    loadFeed();
                } else if (currentPage === 'profile') {
                    loadProfile();
                } else if (currentPage === 'userProfile') {
                    loadUserProfilePosts(viewedUser.userId);
                }
                
            } catch (e) {
                console.error('Retweet error:', e);
                alert('Retweet failed. Please try again.');
            }
        }
        
        async function incrementPostView(postId) {
            if (!currentUser) return;
            
            try {
                const viewRef = window.firebaseRef(window.firebaseDB, 'views/' + postId + '/' + currentUser.userId);
                
                // Check if user already viewed this post
                const viewSnap = await window.firebaseGet(viewRef);
                
                if (!viewSnap.exists()) {
                    // Mark as viewed
                    await window.firebaseSet(viewRef, {
                        userId: currentUser.userId,
                        timestamp: Date.now()
                    });
                    
                    // Increase view count
                    const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + postId);
                    const postSnap = await window.firebaseGet(postRef);
                    if (postSnap.exists()) {
                        const post = postSnap.val();
                        await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'posts/' + postId + '/views'), (post.views || 0) + 1);
                    }
                }
            } catch (e) {
                console.error('View increment error:', e);
            }
        }
        
        
        // --- Overlay notifications renderer (v19) ---
        function getNotifIcon(type) {
            if (type === 'follow') return 'ðŸ‘¤';
            if (type === 'retweet') return 'ðŸ”';
            if (type === 'comment') return 'ðŸ’¬';
            return 'â¤ï¸';
        }

        function getNotifActionText(type) {
            if (type === 'follow') return 'followed you';
            if (type === 'retweet') return 'reposted your post';
            if (type === 'comment') return 'commented on your post';
            return 'liked your post';
        }

        function renderOverlayNotifications() {
            const list = document.getElementById('notificationsOverlayList');
            if (!list) { console.warn('notificationsOverlayList not found'); return; }

            if (!notificationsState.items.length) {
                list.innerHTML = `
                    <div style="text-align:center; padding: 30px 0; opacity:.65;">
                        No notifications yet.
                    </div>
                `;
                return;
            }

            list.innerHTML = notificationsState.items.map(n => {
                const pirateName = escapeHtml(n.actorPirateName || '');
                const handle = escapeHtml(n.actorUsername || '');
                const who = pirateName || handle || 'Someone';

                const icon = getNotifIcon(n.type);
                const actionText = getNotifActionText(n.type);
                const time = formatTimeAgo(n.createdAt);

                let snippet = '';
                if (n.type === 'comment' && n.commentSnippet) snippet = n.commentSnippet;
                else if (n.postSnippet) snippet = n.postSnippet;

                const snippetHtml = snippet ? `<div class="notif-snippet">â€œ${escapeHtml(snippet)}â€</div>` : '';

                return `
                    <div class="notif-row ${n.read ? '' : 'notif-unread'}" onclick="openNotification('${n.id}')">
                        <div class="notif-lefticon">${icon}</div>
                        <div class="notif-avatar" aria-hidden="true">
                            <div class="notif-avatar-inner">${escapeHtml((who || 'U').slice(0,1).toUpperCase())}</div>
                        </div>
                        <div class="notif-body">
                            <div class="notif-topline">
                                <span class="notif-name">${escapeHtml(pirateName || who)}</span>
                                ${handle ? `<span class="notif-handle">@${handle}</span>` : ''}
                                <span class="notif-dot">Â·</span>
                                <span class="notif-time">${escapeHtml(time)}</span>
                            </div>
                            <div class="notif-action">${escapeHtml(actionText)}</div>
                            ${snippetHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }
        // --- End overlay notifications renderer (v19) ---


        // === PAGE SWITCHING ===
        function openNotificationsOverlay() {
            const ov = document.getElementById('notificationsOverlay');
            if (ov) { ov.style.display = 'block';
            try { startNotificationListener(); } catch (e) { console.error(e); }
            requestAnimationFrame(() => { try { renderOverlayNotifications(); } catch (e) { console.error(e); } }); 
            renderOverlayNotifications();
}
            
        }

        function closeNotificationsOverlay() {
            const ov = document.getElementById('notificationsOverlay');
            if (ov) { ov.style.display = 'none'; }
        }

        function switchPage(page) {
            // Hide all pages
            safeSetDisplay('homePage','none');
            safeSetDisplay('profilePage','none');
            safeSetDisplay('trendingPage','none');
            safeSetDisplay('searchPage','none');
            safeSetDisplay('notificationsPage','none');
            safeSetDisplay('settingsPage','none');
            safeSetDisplay('userProfilePage','none');
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page and activate nav item
            if (page === 'home') {
                safeSetDisplay('homePage','block');
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else if (page === 'trending') {
                safeSetDisplay('trendingPage','block');
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            } else if (page === 'search') {
                safeSetDisplay('searchPage','block');
                document.querySelectorAll('.nav-item')[2].classList.add('active');
            } else if (page === 'notifications') {
                safeSetDisplay('notificationsPage','block');
                const np = document.getElementById('notificationsPage');
                if (np) { np.style.visibility = 'visible'; np.style.opacity = '1'; np.style.transform = 'none'; }
                document.querySelectorAll('.nav-item')[3].classList.add('active');
                // Render immediately (in case we already have items)
                renderNotifications();
                // If the page area is still not visible (layout/CSS issue), use overlay failsafe
                const npEl = document.getElementById('notificationsPage');
                const visible = npEl && npEl.offsetWidth > 0 && npEl.offsetHeight > 0;
                if (!visible) {
                    openNotificationsOverlay();
                }
                console.log('ðŸ”” Notifications page opened. items=', notificationsState.items.length, 'unread=', notificationsState.unreadCount);
                // Scroll to top for good UX
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (page === 'profile') {
                safeSetDisplay('profilePage','block');
                document.querySelectorAll('.nav-item')[4].classList.add('active');
                loadProfile();
            } else if (page === 'settings') {
                safeSetDisplay('settingsPage','block');
                document.querySelectorAll('.nav-item')[5].classList.add('active');
            }
        }
        
        async function loadProfile() {
            if (!currentUser) return;
            
            // Load user profile data from Firebase
            try {
                const userRef = window.firebaseRef(window.firebaseDB, 'users/' + currentUser.userId);
                const userSnap = await window.firebaseGet(userRef);
                
                if (userSnap.exists()) {
                    const userData = userSnap.val();
                    
                    // Update current user with profile data
                    // DON'T override profilePhoto if we already have one (might be newer than Firebase)
                    if (userData.profilePhoto && !currentUser.profilePhoto) {
                        currentUser.profilePhoto = userData.profilePhoto;
                    }
                    if (userData.banner) {
                        currentUser.banner = userData.banner;
                    }
                    if (userData.bio) {
                        currentUser.bio = userData.bio;
                    }
                }
            } catch (e) {
                console.error('Error loading user data:', e);
            }
            
            // Set profile info
            document.getElementById('profilePirateName').textContent = currentUser.pirateName;
            document.getElementById('profileUsername').textContent = '@' + currentUser.username;
            
            // Set profile photo
            const profileAvatar = document.getElementById('profileAvatar');
            if (currentUser.profilePhoto) {
                profileAvatar.innerHTML = `<img src="${currentUser.profilePhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else {
                profileAvatar.textContent = currentUser.pirateName.charAt(0).toUpperCase();
            }
            
            // Set banner
            const profileBanner = document.getElementById('profileBanner');
            if (currentUser.banner) {
                profileBanner.style.background = 'none';
                profileBanner.style.backgroundImage = `url(${currentUser.banner})`;
                profileBanner.style.backgroundSize = 'cover';
                profileBanner.style.backgroundPosition = 'center';
            } else {
                profileBanner.style.background = 'linear-gradient(135deg, var(--terminal-green), var(--primary-gold))';
                profileBanner.style.backgroundImage = 'none';
            }
            
            // Set bio
            const profileBio = document.getElementById('profileBio');
            if (currentUser.bio) {
                profileBio.textContent = currentUser.bio;
                profileBio.style.display = 'block';
            } else {
                profileBio.textContent = 'No bio yet. Click "Edit Profile" to add one! ðŸ´â€â˜ ï¸';
                profileBio.style.opacity = '0.5';
            }
            
            try {
                
                // Get all posts
                const postsRef = window.firebaseRef(window.firebaseDB, 'posts');
                const postsSnap = await window.firebaseGet(postsRef);
                
                let allPosts = [];
                let totalLikes = 0;
                let totalRetweets = 0;
                let totalViews = 0;
                
                // Load user's own posts
                if (postsSnap.exists()) {
                    postsSnap.forEach(snap => {
                        const post = { id: snap.key, ...snap.val() };
                        if (post.userId === currentUser.userId) {
                            allPosts.push({
                                ...post,
                                timestamp: post.timestamp,
                                isRetweet: false
                            });
                            totalLikes += (post.likes || 0);
                            totalRetweets += (post.reposts || 0);
                            totalViews += (post.views || 0);
                        }
                    });
                }
                
                // Load user's retweets
                const userRetweetsRef = window.firebaseRef(window.firebaseDB, 'userRetweets/' + currentUser.userId);
                const userRetweetsSnap = await window.firebaseGet(userRetweetsRef);
                
                if (userRetweetsSnap.exists()) {
                    const retweets = userRetweetsSnap.val();
                    
                    for (const postId in retweets) {
                        const retweetData = retweets[postId];
                        const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + postId);
                        const postSnap = await window.firebaseGet(postRef);
                        
                        if (postSnap.exists()) {
                            const originalPost = { id: postSnap.key, ...postSnap.val() };
                            allPosts.push({
                                ...originalPost,
                                timestamp: retweetData.retweetTimestamp,
                                isRetweet: true,
                                retweeterName: currentUser.pirateName
                            });
                        }
                    }
                }
                
                // Update stats
                document.getElementById('profilePostCount').textContent = allPosts.filter(p => !p.isRetweet).length;
                document.getElementById('profileLikeCount').textContent = totalLikes;
                
                // Load followers/following counts
                loadProfileStats();
                
                // Sort posts by timestamp (newest first)
                allPosts.sort((a, b) => b.timestamp - a.timestamp);
                
                // Check like and retweet status for each post
                for (let post of allPosts) {
                    const likeRef = window.firebaseRef(window.firebaseDB, 'likes/' + post.id + '/' + currentUser.userId);
                    const likeSnap = await window.firebaseGet(likeRef);
                    post.likedByCurrentUser = likeSnap.exists();
                    
                    const retweetRef = window.firebaseRef(window.firebaseDB, 'retweets/' + post.id + '/' + currentUser.userId);
                    const retweetSnap = await window.firebaseGet(retweetRef);
                    post.retweetedByCurrentUser = retweetSnap.exists();
                }
                
                // Display user posts
                const profilePosts = document.getElementById('profilePosts');
                
                if (!profilePosts) {
                    console.error('âŒ profilePosts element NOT FOUND in DOM!');
                    return;
                }
                
                profilePosts.innerHTML = '';
                
                if (allPosts.length === 0) {
                    profilePosts.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-white); opacity: 0.5;">No posts yet. Share your first post! ðŸ´â€â˜ ï¸</div>';
                } else {
                    allPosts.forEach((post, index) => {
                        const postEl = createPostElement(post, post.isRetweet, post.retweeterName);
                        profilePosts.appendChild(postEl);
                    });
                    
                    // DEBUG: Check if posts are visible
                    setTimeout(() => {
                        const posts = document.querySelectorAll('#profilePosts .post');
                        posts.forEach((post, i) => {
                            const styles = window.getComputedStyle(post);
                            console.log(`  Post ${i + 1}: display=${styles.display}, opacity=${styles.opacity}, visibility=${styles.visibility}, height=${styles.height}`);
                        });
                        
                        const profilePage = document.getElementById('profilePage');
                        const profilePageStyles = window.getComputedStyle(profilePage);
                    }, 100);
                }
                
            } catch (e) {
                console.error('Profile load error:', e);
            }
            
        }
        
        // Reload only the posts section without overriding currentUser data
        async function reloadProfilePosts() {
            if (!currentUser) return;
            
            try {
                console.log('ðŸ”„ Reloading profile posts with updated avatar...');
                
                // Get all posts
                const postsRef = window.firebaseRef(window.firebaseDB, 'posts');
                const postsSnap = await window.firebaseGet(postsRef);
                
                let userPosts = [];
                
                if (postsSnap.exists()) {
                    postsSnap.forEach(snap => {
                        const post = { id: snap.key, ...snap.val() };
                        if (post.userId === currentUser.userId) {
                            userPosts.push(post);
                        }
                    });
                }
                
                // Sort posts by timestamp (newest first)
                userPosts.sort((a, b) => b.timestamp - a.timestamp);
                
                // Display user posts
                const profilePosts = document.getElementById('profilePosts');
                profilePosts.innerHTML = '';
                
                if (userPosts.length === 0) {
                    profilePosts.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-white); opacity: 0.5;">No posts yet. Share your first post! ðŸ´â€â˜ ï¸</div>';
                } else {
                    userPosts.forEach(post => {
                        const postEl = createPostElement(post);
                        profilePosts.appendChild(postEl);
                    });
                }
                
                console.log('âœ… Profile posts reloaded with updated avatar');
                
            } catch (e) {
                console.error('Reload profile posts error:', e);
            }
        }
        
        // Textarea auto-resize
        const textarea = document.getElementById('postTextarea');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        
        // === COMMENT SYSTEM ===
        let currentPostForComment = null;
        let selectedCommentImage = null;
        
        function handleCommentImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                alert('Image too large! Max 2MB');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedCommentImage = e.target.result;
                document.getElementById('commentPreviewImg').src = selectedCommentImage;
                document.getElementById('commentImagePreview').classList.add('active');
            };
            reader.readAsDataURL(file);
        }
        
        function removeCommentImage() {
            selectedCommentImage = null;
            document.getElementById('commentImagePreview').classList.remove('active');
            document.getElementById('commentImageInput').value = '';
        }
        
        async function openCommentModal(postId) {
            currentPostForComment = postId;
            
            // Get post data
            const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + postId);
            const postSnap = await window.firebaseGet(postRef);
            
            if (!postSnap.exists()) return;
            
            const post = postSnap.val();
            
            // Show original post
            document.getElementById('modalOriginalPost').innerHTML = `
                <div class="post-header">
                    <div class="user-avatar">${post.pirateName.charAt(0).toUpperCase()}</div>
                    <div class="post-content-area">
                        <div class="post-user-info">
                            <span class="post-username">${post.pirateName}</span>
                            <span class="post-handle">@${post.username}</span>
                        </div>
                        <div class="post-text">${linkifyText(post.text)}</div>
                    </div>
                </div>
            `;
            
            // Load comments
            loadComments(postId);
            
            // Show modal
            document.getElementById('commentModal').classList.add('active');
        }
        
        function closeCommentModal() {
            try { if (commentsUnsub) { commentsUnsub(); commentsUnsub = null; } } catch(e) {}
            document.getElementById('commentModal').classList.remove('active');
            document.getElementById('commentTextarea').value = '';
            removeCommentImage();
            currentPostForComment = null;
        }
        
        async function postComment() {
            if (!currentUser || !currentPostForComment) return;
            
            const textarea = document.getElementById('commentTextarea');
            const text = textarea.value.trim();
            
            if (!text && !selectedCommentImage) return;
            
            const commentButton = document.querySelector('.comment-button');
            commentButton.disabled = true;
            commentButton.textContent = 'Posting...';
            
            try {
                // Add comment
                const commentsRef = window.firebaseRef(window.firebaseDB, 'comments/' + currentPostForComment);
                const commentData = {
                    userId: currentUser.userId,
                    username: currentUser.username,
                    pirateName: currentUser.pirateName,
                    text: text,
                    timestamp: Date.now(),
                    likes: 0,
                    reposts: 0,
                    replies: 0
                };
                
                // Add image if selected
                if (selectedCommentImage) {
                    commentData.image = selectedCommentImage;
                }
                
                await window.firebasePush(commentsRef, commentData);
                
                // Increase comment count on post
                const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + currentPostForComment);
                const postSnap = await window.firebaseGet(postRef);
                if (postSnap.exists()) {
                    const post = postSnap.val();
                    await window.firebaseSet(
                        window.firebaseRef(window.firebaseDB, 'posts/' + currentPostForComment + '/comments'),
                        (post.comments || 0) + 1
                    );
                
                    // Notify post owner
                    await createNotification(post.userId, 'comment', { postId: currentPostForComment, postSnippet: (post.text || '').slice(0, 120), commentSnippet: (text || '').slice(0, 120) });
                }
                
                textarea.value = '';
                removeCommentImage();
                dlog('âœ… Comment posted');
                
            } catch (e) {
                console.error('Comment error:', e);
                alert('Error posting comment. Image might be too large.');
            } finally {
                commentButton.disabled = false;
                commentButton.textContent = 'Comment';
            }
        }
        
        async function loadComments(postId) {
            try {
                const commentsRef = window.firebaseRef(window.firebaseDB, 'comments/' + postId);
                
            try { if (feedUnsub) feedUnsub(); } catch(e) {}
            feedUnsub = commentsUnsub && commentsUnsub();
                commentsUnsub = window.firebaseOnValue(commentsRef, (snapshot) => {
                    const comments = [];
                    snapshot.forEach(s => {
                        comments.push({ id: s.key, ...s.val() });
                    });
                    
                    // Sort by timestamp (newest first)
                    comments.sort((a, b) => b.timestamp - a.timestamp);
                    
                    displayComments(comments);
                });
                
            } catch (e) {
                console.error('Load comments error:', e);
            }
        }
        
        function displayComments(comments) {
            const commentsList = document.getElementById('commentsList');
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-white); opacity: 0.5;">No comments yet. Be the first! ðŸ’¬</div>';
                return;
            }
            
            commentsList.innerHTML = '';
            
            comments.forEach(comment => {
                const div = document.createElement('div');
                div.className = 'comment-item';
                
                const timeAgo = getTimeAgo(comment.timestamp);
                
                // Image HTML if exists
                const imageHtml = comment.image ? `<img src="${comment.image}" class="post-image" loading="lazy" alt="Comment image" onclick="openImageModal('${comment.image}')">` : '';
                
                div.innerHTML = `
                    <div class="post-header">
                        <div class="user-avatar">${comment.pirateName.charAt(0).toUpperCase()}</div>
                        <div class="post-content-area">
                            <div class="post-user-info">
                                <span class="post-username">${comment.pirateName}</span>
                                <span class="post-handle">@${comment.username}</span>
                                <span class="post-time">Â· ${timeAgo}</span>
                            </div>
                            <div class="post-text">${linkifyText(comment.text)}</div>
                            ${imageHtml}
                            <div class="post-stats">
                                <div class="post-stat" onclick="replyToComment('${comment.id}', '${comment.pirateName}')" style="cursor: pointer;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                                    </svg>
                                    <span>${comment.replies || 0}</span>
                                </div>
                                <div class="post-stat" onclick="retweetComment('${comment.id}')" style="cursor: pointer;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="17 1 21 5 17 9"></polyline>
                                        <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                                        <polyline points="7 23 3 19 7 15"></polyline>
                                        <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                                    </svg>
                                    <span>${comment.reposts || 0}</span>
                                </div>
                                <div class="post-stat" onclick="likeComment('${comment.id}')" style="cursor: pointer;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                    </svg>
                                    <span>${comment.likes || 0}</span>
                                </div>
                            </div>
                            
                            <!-- Reply Input Box (hidden by default) -->
                            <div class="reply-box" id="replyBox-${comment.id}" style="display: none; margin-top: 12px; padding: 12px; background: rgba(220, 20, 60, 0.05); border-radius: 8px;">
                                <textarea 
                                    class="comment-textarea" 
                                    id="replyTextarea-${comment.id}"
                                    placeholder="Reply to @${comment.username}..."
                                    maxlength="280"
                                    style="min-height: 60px; margin-bottom: 8px;"
                                ></textarea>
                                <div style="display: flex; justify-content: flex-end; gap: 8px;">
                                    <button onclick="cancelReply('${comment.id}')" style="padding: 6px 16px; background: transparent; border: 1px solid var(--border-color); color: var(--text-white); border-radius: 6px; cursor: pointer; font-family: 'Orbitron', sans-serif;">Cancel</button>
                                    <button onclick="submitReply('${comment.id}')" style="padding: 6px 16px; background: var(--terminal-green); border: none; color: white; border-radius: 6px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-weight: 600;">Reply</button>
                                </div>
                            </div>
                            
                            <!-- Nested Replies -->
                            <div class="nested-replies" id="replies-${comment.id}" style="margin-top: 12px; margin-left: 20px; border-left: 2px solid rgba(220, 20, 60, 0.2); padding-left: 12px;">
                            </div>
                        </div>
                    </div>
                `;
                
                commentsList.appendChild(div);
                
                // Load replies for this comment
                loadReplies(comment.id);
            });
        }
        
        async function likeComment(commentId) {
            if (!currentUser || !currentPostForComment) return;
            
            try {
                const commentRef = window.firebaseRef(window.firebaseDB, 'comments/' + currentPostForComment + '/' + commentId);
                const likeRef = window.firebaseRef(window.firebaseDB, 'commentLikes/' + currentPostForComment + '/' + commentId + '/' + currentUser.userId);
                
                // Check if already liked
                const likeSnap = await window.firebaseGet(likeRef);
                
                if (likeSnap.exists()) {
                    // Unlike
                    await window.firebaseSet(likeRef, null);
                    
                    // Decrease like count
                    const commentSnap = await window.firebaseGet(commentRef);
                    if (commentSnap.exists()) {
                        const comment = commentSnap.val();
                        await window.firebaseSet(
                            window.firebaseRef(window.firebaseDB, 'comments/' + currentPostForComment + '/' + commentId + '/likes'),
                            Math.max(0, (comment.likes || 0) - 1)
                        );
                    }
                } else {
                    // Like
                    await window.firebaseSet(likeRef, {
                        userId: currentUser.userId,
                        timestamp: Date.now()
                    });
                    
                    // Increase like count
                    const commentSnap = await window.firebaseGet(commentRef);
                    if (commentSnap.exists()) {
                        const comment = commentSnap.val();
                        await window.firebaseSet(
                            window.firebaseRef(window.firebaseDB, 'comments/' + currentPostForComment + '/' + commentId + '/likes'),
                            (comment.likes || 0) + 1
                        );
                    }
                }
                
                dlog('âœ… Comment like toggled');
                
            } catch (e) {
                console.error('Comment like error:', e);
            }
        }
        
        async function retweetComment(commentId) {
            if (!currentUser || !currentPostForComment) return;
            
            try {
                const commentRef = window.firebaseRef(window.firebaseDB, 'comments/' + currentPostForComment + '/' + commentId);
                const retweetRef = window.firebaseRef(window.firebaseDB, 'commentRetweets/' + currentPostForComment + '/' + commentId + '/' + currentUser.userId);
                
                // Check if already retweeted
                const retweetSnap = await window.firebaseGet(retweetRef);
                
                if (retweetSnap.exists()) {
                    // Un-retweet
                    await window.firebaseSet(retweetRef, null);
                    
                    // Decrease retweet count
                    const commentSnap = await window.firebaseGet(commentRef);
                    if (commentSnap.exists()) {
                        const comment = commentSnap.val();
                        await window.firebaseSet(
                            window.firebaseRef(window.firebaseDB, 'comments/' + currentPostForComment + '/' + commentId + '/reposts'),
                            Math.max(0, (comment.reposts || 0) - 1)
                        );
                    }
                } else {
                    // Retweet
                    await window.firebaseSet(retweetRef, {
                        userId: currentUser.userId,
                        timestamp: Date.now()
                    });
                    
                    // Increase retweet count
                    const commentSnap = await window.firebaseGet(commentRef);
                    if (commentSnap.exists()) {
                        const comment = commentSnap.val();
                        await window.firebaseSet(
                            window.firebaseRef(window.firebaseDB, 'comments/' + currentPostForComment + '/' + commentId + '/reposts'),
                            (comment.reposts || 0) + 1
                        );
                    }
                }
                
                dlog('âœ… Comment retweet toggled');
                
            } catch (e) {
                console.error('Comment retweet error:', e);
            }
        }
        
        function replyToComment(commentId, pirateName) {
            // Toggle reply box visibility
            const replyBox = document.getElementById('replyBox-' + commentId);
            const isVisible = replyBox.style.display !== 'none';
            
            // Hide all other reply boxes
            document.querySelectorAll('.reply-box').forEach(box => {
                box.style.display = 'none';
            });
            
            // Toggle current reply box
            if (!isVisible) {
                replyBox.style.display = 'block';
                document.getElementById('replyTextarea-' + commentId).focus();
            }
        }
        
        function cancelReply(commentId) {
            document.getElementById('replyBox-' + commentId).style.display = 'none';
            document.getElementById('replyTextarea-' + commentId).value = '';
        }
        
        async function submitReply(commentId) {
            if (!currentUser || !currentPostForComment) return;
            
            const textarea = document.getElementById('replyTextarea-' + commentId);
            const text = textarea.value.trim();
            
            if (!text) return;
            
            try {
                // Add reply to Firebase
                const repliesRef = window.firebaseRef(window.firebaseDB, 'replies/' + currentPostForComment + '/' + commentId);
                const replyData = {
                    userId: currentUser.userId,
                    username: currentUser.username,
                    pirateName: currentUser.pirateName,
                    text: text,
                    timestamp: Date.now(),
                    likes: 0
                };
                
                await window.firebasePush(repliesRef, replyData);
                
                // Increase reply count on comment
                const commentRef = window.firebaseRef(window.firebaseDB, 'comments/' + currentPostForComment + '/' + commentId);
                const commentSnap = await window.firebaseGet(commentRef);
                if (commentSnap.exists()) {
                    const comment = commentSnap.val();
                    await window.firebaseSet(
                        window.firebaseRef(window.firebaseDB, 'comments/' + currentPostForComment + '/' + commentId + '/replies'),
                        (comment.replies || 0) + 1
                    );
                }
                
                // Clear and hide reply box
                textarea.value = '';
                cancelReply(commentId);
                
                // Load replies
                loadReplies(commentId);
                
                console.log('âœ… Reply posted');
                
            } catch (e) {
                console.error('Reply error:', e);
                alert('Error posting reply');
            }
        }
        
        async function loadReplies(commentId) {
            try {
                const repliesRef = window.firebaseRef(window.firebaseDB, 'replies/' + currentPostForComment + '/' + commentId);
                
                const repliesSnap = await window.firebaseGet(repliesRef);
                const repliesContainer = document.getElementById('replies-' + commentId);
                
                if (!repliesSnap.exists()) {
                    repliesContainer.innerHTML = '';
                    return;
                }
                
                const replies = [];
                repliesSnap.forEach(snap => {
                    replies.push({ id: snap.key, ...snap.val() });
                });
                
                // Sort by timestamp
                replies.sort((a, b) => a.timestamp - b.timestamp);
                
                repliesContainer.innerHTML = '';
                
                replies.forEach(reply => {
                    const timeAgo = getTimeAgo(reply.timestamp);
                    const replyDiv = document.createElement('div');
                    replyDiv.className = 'nested-reply';
                    replyDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: rgba(220, 20, 60, 0.03); border-radius: 8px;';
                    
                    replyDiv.innerHTML = `
                        <div style="display: flex; gap: 10px;">
                            <div class="user-avatar" style="width: 32px; height: 32px; font-size: 0.9rem;">${reply.pirateName.charAt(0).toUpperCase()}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 6px; align-items: center; margin-bottom: 6px;">
                                    <span style="color: var(--primary-gold); font-weight: 700; font-size: 0.9rem;">${reply.pirateName}</span>
                                    <span style="color: var(--text-white); opacity: 0.5; font-size: 0.85rem;">@${reply.username}</span>
                                    <span style="color: var(--text-white); opacity: 0.5; font-size: 0.85rem;">Â· ${timeAgo}</span>
                                </div>
                                <div style="color: var(--text-white); font-size: 0.9rem; line-height: 1.5;">${escapeHtml(reply.text)}</div>
                            </div>
                        </div>
                    `;
                    
                    repliesContainer.appendChild(replyDiv);
                });
                
            } catch (e) {
                console.error('Load replies error:', e);
            }
        }
        
        // === IMAGE MODAL ===
        function togglePostMenu(event, postId) {
            event.stopPropagation();
            
            // Close all other menus
            document.querySelectorAll('.post-menu-dropdown').forEach(menu => {
                if (menu.id !== 'menu-' + postId) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle current menu
            const menu = document.getElementById('menu-' + postId);
            menu.classList.toggle('show');
        }
        
        // Close menus when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.post-menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
        });
        
        async function deletePost(postId) {
            if (!currentUser) return;
            
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }
            
            try {
                // Delete the post
                const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + postId);
                await window.firebaseSet(postRef, null);
                
                // Delete associated likes
                const likesRef = window.firebaseRef(window.firebaseDB, 'likes/' + postId);
                await window.firebaseSet(likesRef, null);
                
                // Delete associated retweets
                const retweetsRef = window.firebaseRef(window.firebaseDB, 'retweets/' + postId);
                await window.firebaseSet(retweetsRef, null);
                
                // Delete associated comments
                const commentsRef = window.firebaseRef(window.firebaseDB, 'comments/' + postId);
                await window.firebaseSet(commentsRef, null);
                
                // Delete associated comment likes
                const commentLikesRef = window.firebaseRef(window.firebaseDB, 'commentLikes/' + postId);
                await window.firebaseSet(commentLikesRef, null);
                
                // Delete associated comment retweets
                const commentRetweetsRef = window.firebaseRef(window.firebaseDB, 'commentRetweets/' + postId);
                await window.firebaseSet(commentRetweetsRef, null);
                
                // Delete associated replies
                const repliesRef = window.firebaseRef(window.firebaseDB, 'replies/' + postId);
                await window.firebaseSet(repliesRef, null);
                
                console.log('âœ… Post deleted successfully');
                
                // Reload feed
                loadFeed();
                
            } catch (e) {
                console.error('Delete post error:', e);
                alert('Error deleting post');
            }
        }
        
        
        // === PROFILE EDIT FUNCTIONS ===
        function toggleEditProfile() {
            const form = document.getElementById('editProfileForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
            } else {
                // Load current bio
                const bioTextarea = document.getElementById('editBioTextarea');
                bioTextarea.value = currentUser.bio || '';
                updateBioCharCount();
                form.style.display = 'block';
            }
        }
        
        function cancelEditProfile() {
            document.getElementById('editProfileForm').style.display = 'none';
        }
        
        function editBanner() {
            document.getElementById('bannerInput').click();
        }
        
        function editProfilePhoto() {
            document.getElementById('profilePhotoInput').click();
        }
        
        function handleBannerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 3MB)
            if (file.size > 3 * 1024 * 1024) {
                alert('Image too large! Max 3MB');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const bannerData = e.target.result;
                
                try {
                    // Save to Firebase
                    const userRef = window.firebaseRef(window.firebaseDB, 'users/' + currentUser.userId + '/banner');
                    await window.firebaseSet(userRef, bannerData);
                    
                    // Update local
                    currentUser.banner = bannerData;
                    
                    // Update localStorage
                    localStorage.setItem('compass_user', JSON.stringify(currentUser));
                    
                    // Update UI
                    const profileBanner = document.getElementById('profileBanner');
                    profileBanner.style.background = 'none';
                    profileBanner.style.backgroundImage = `url(${bannerData})`;
                    profileBanner.style.backgroundSize = 'cover';
                    profileBanner.style.backgroundPosition = 'center';
                    
                    console.log('âœ… Banner updated');
                    
                } catch (e) {
                    console.error('Banner upload error:', e);
                    alert('Error uploading banner');
                }
            };
            reader.readAsDataURL(file);
        }
        
        function handleProfilePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('Image too large! Max 2MB');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const photoData = e.target.result;
                
                try {
                    // Save to Firebase
                    const userRef = window.firebaseRef(window.firebaseDB, 'users/' + currentUser.userId + '/profilePhoto');
                    await window.firebaseSet(userRef, photoData);
                    
                    // Update local
                    currentUser.profilePhoto = photoData;
                    console.log('ðŸ“¸ NEW photoData (first 50 chars):', photoData.substring(0, 50));
                    
                    // Update localStorage
                    localStorage.setItem('compass_user', JSON.stringify(currentUser));
                    
                    // Update profile page avatar
                    const profileAvatar = document.getElementById('profileAvatar');
                    if (profileAvatar) {
                        profileAvatar.innerHTML = `<img src="${photoData}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    }
                    
                    // Update post box avatar
                    const postAvatar = document.getElementById('postAvatar');
                    if (postAvatar) {
                        postAvatar.innerHTML = `<img src="${photoData}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    }
                    
                    console.log('âœ… Profile photo updated');
                    
                    // Don't call loadProfile() because it will override currentUser.profilePhoto with old Firebase data
                    // Instead, just reload the posts section
                    reloadProfilePosts();
                    
                } catch (e) {
                    console.error('Profile photo upload error:', e);
                    alert('Error uploading profile photo');
                }
            };
            reader.readAsDataURL(file);
        }
        
        async function saveProfile() {
            if (!currentUser) return;
            
            const bio = document.getElementById('editBioTextarea').value.trim();
            
            try {
                // Save bio to Firebase
                const userRef = window.firebaseRef(window.firebaseDB, 'users/' + currentUser.userId + '/bio');
                await window.firebaseSet(userRef, bio);
                
                // Update local
                currentUser.bio = bio;
                
                // Update localStorage
                localStorage.setItem('compass_user', JSON.stringify(currentUser));
                
                // Update UI
                const profileBio = document.getElementById('profileBio');
                if (bio) {
                    profileBio.textContent = bio;
                    profileBio.style.opacity = '1';
                } else {
                    profileBio.textContent = 'No bio yet. Click "Edit Profile" to add one! ðŸ´â€â˜ ï¸';
                    profileBio.style.opacity = '0.5';
                }
                
                // Hide form
                cancelEditProfile();
                
                console.log('âœ… Profile saved');
                
            } catch (e) {
                console.error('Save profile error:', e);
                alert('Error saving profile');
            }
        }
        
        function updateBioCharCount() {
            const bioTextarea = document.getElementById('editBioTextarea');
            const charCount = document.getElementById('bioCharCount');
            if (bioTextarea && charCount) {
                charCount.textContent = bioTextarea.value.length;
            }
        }
        
        // === IMAGE MODAL ===
        function openImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 10002;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            modal.appendChild(img);
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }
        
        // === FOLLOW SYSTEM ===
        async function toggleFollow(targetUserId, targetUsername) {
            if (!currentUser) return;
            
            try {
                const followRef = window.firebaseRef(window.firebaseDB, `follows/${currentUser.userId}/${targetUserId}`);
                const followSnap = await window.firebaseGet(followRef);
                
                if (followSnap.exists()) {
                    // Unfollow
                    await window.firebaseSet(followRef, null);
                    
                    // Remove from target's followers
                    const followerRef = window.firebaseRef(window.firebaseDB, `followers/${targetUserId}/${currentUser.userId}`);
                    await window.firebaseSet(followerRef, null);
                    
                    console.log('âœ… Unfollowed:', targetUsername);
                } else {
                    // Follow
                    await window.firebaseSet(followRef, {
                        username: targetUsername,
                        timestamp: Date.now()
                    });
                    
                    // Add to target's followers
                    const followerRef = window.firebaseRef(window.firebaseDB, `followers/${targetUserId}/${currentUser.userId}`);
                    await window.firebaseSet(followerRef, {
                        username: currentUser.username,
                        timestamp: Date.now()
                    });
                    
                    
                    // Notify target user
                    await createNotification(targetUserId, 'follow', {});
                    console.log('âœ… Followed:', targetUsername);
                }
                
                // Reload the who to follow list
                loadWhoToFollow();
                loadProfileStats();
                
            } catch (e) {
                console.error('Follow error:', e);
                alert('Error updating follow status');
            }
        }
        
        async function isFollowing(targetUserId) {
            if (!currentUser) return false;
            
            try {
                const followRef = window.firebaseRef(window.firebaseDB, `follows/${currentUser.userId}/${targetUserId}`);
                const followSnap = await window.firebaseGet(followRef);
                return followSnap.exists();
            } catch (e) {
                console.error('Check follow error:', e);
                return false;
            }
        }
        
        async function loadWhoToFollow() {
            if (!currentUser) return;
            
            try {
                const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (!snapshot.exists()) return;
                
                const users = snapshot.val();
                const usersList = Object.entries(users)
                    .filter(([userId, _]) => userId !== currentUser.userId)
                    .map(([userId, userData]) => ({
                        userId,
                        ...userData
                    }));
                
                // Shuffle and take random 3 users
                const shuffled = usersList.sort(() => 0.5 - Math.random());
                const suggestions = shuffled.slice(0, 3);
                
                const container = document.getElementById('whoToFollowList');
                if (!container) return;
                
                container.innerHTML = '';
                
                for (const user of suggestions) {
                    const following = await isFollowing(user.userId);
                    
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-suggest-item';
                    userDiv.innerHTML = `
                        <div class="user-suggest-info" style="cursor: pointer;" onclick="viewUserProfile('${user.userId}')">
                            <div class="user-suggest-name">${user.pirateName || user.username}</div>
                            <div class="user-suggest-bio">${user.bio ? (user.bio.length > 40 ? user.bio.substring(0, 40) + '...' : user.bio) : '@' + user.username}</div>
                        </div>
                        <button class="follow-btn ${following ? 'following' : ''}" onclick="toggleFollow('${user.userId}', '${user.username}')">
                            ${following ? 'Following' : 'Follow'}
                        </button>
                    `;
                    container.appendChild(userDiv);
                }
                
            } catch (e) {
                console.error('Load who to follow error:', e);
            }
        }
        
        async function loadProfileStats() {
            if (!currentUser) return;
            
            try {
                // Load followers count
                const followersRef = window.firebaseRef(window.firebaseDB, `followers/${currentUser.userId}`);
                const followersSnap = await window.firebaseGet(followersRef);
                const followersCount = followersSnap.exists() ? Object.keys(followersSnap.val()).length : 0;
                
                // Load following count
                const followingRef = window.firebaseRef(window.firebaseDB, `follows/${currentUser.userId}`);
                const followingSnap = await window.firebaseGet(followingRef);
                const followingCount = followingSnap.exists() ? Object.keys(followingSnap.val()).length : 0;
                
                // Update UI
                const followersEl = document.getElementById('profileFollowersCount');
                const followingEl = document.getElementById('profileFollowingCount');
                
                if (followersEl) followersEl.textContent = followersCount;
                if (followingEl) followingEl.textContent = followingCount;
                
            } catch (e) {
                console.error('Load profile stats error:', e);
            }
        }
        
        async function showFollowers() {
            if (!currentUser) return;
            
            const modal = document.getElementById('followersModal');
            const title = document.getElementById('followersModalTitle');
            const list = document.getElementById('followersModalList');
            
            title.textContent = 'ðŸ‘¥ Followers';
            list.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.5;">Loading...</div>';
            modal.classList.add('active');
            
            try {
                const followersRef = window.firebaseRef(window.firebaseDB, `followers/${currentUser.userId}`);
                const followersSnap = await window.firebaseGet(followersRef);
                
                list.innerHTML = '';
                
                if (!followersSnap.exists()) {
                    list.innerHTML = '<div class="followers-modal-empty">No followers yet ðŸ´â€â˜ ï¸</div>';
                    return;
                }
                
                const followers = followersSnap.val();
                const followerIds = Object.keys(followers);
                
                // Load full user data for each follower
                for (const followerId of followerIds) {
                    const userRef = window.firebaseRef(window.firebaseDB, `users/${followerId}`);
                    const userSnap = await window.firebaseGet(userRef);
                    
                    if (userSnap.exists()) {
                        const userData = userSnap.val();
                        const isFollowingBack = await isFollowing(followerId);
                        
                        const followerDiv = document.createElement('div');
                        followerDiv.className = 'follower-item';
                        
                        const avatarContent = userData.profilePhoto 
                            ? `<img src="${userData.profilePhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                            : userData.pirateName.charAt(0).toUpperCase();
                        
                        followerDiv.innerHTML = `
                            <div class="follower-info" style="cursor: pointer;" onclick="viewUserProfile('${followerId}')">
                                <div class="follower-avatar">${avatarContent}</div>
                                <div class="follower-details">
                                    <div class="follower-name">${userData.pirateName}</div>
                                    <div class="follower-username">@${userData.username}</div>
                                    ${userData.bio ? `<div class="follower-bio">${userData.bio.length > 60 ? userData.bio.substring(0, 60) + '...' : userData.bio}</div>` : ''}
                                </div>
                            </div>
                            <button class="follow-btn ${isFollowingBack ? 'following' : ''}" onclick="toggleFollowFromModal('${followerId}', '${userData.username}')">
                                ${isFollowingBack ? 'Following' : 'Follow Back'}
                            </button>
                        `;
                        
                        list.appendChild(followerDiv);
                    }
                }
                
            } catch (e) {
                console.error('Load followers error:', e);
                list.innerHTML = '<div class="followers-modal-empty">Error loading followers</div>';
            }
        }
        
        async function showFollowing() {
            if (!currentUser) return;
            
            const modal = document.getElementById('followersModal');
            const title = document.getElementById('followersModalTitle');
            const list = document.getElementById('followersModalList');
            
            title.textContent = 'âž¡ï¸ Following';
            list.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.5;">Loading...</div>';
            modal.classList.add('active');
            
            try {
                const followingRef = window.firebaseRef(window.firebaseDB, `follows/${currentUser.userId}`);
                const followingSnap = await window.firebaseGet(followingRef);
                
                list.innerHTML = '';
                
                if (!followingSnap.exists()) {
                    list.innerHTML = '<div class="followers-modal-empty">Not following anyone yet ðŸ´â€â˜ ï¸</div>';
                    return;
                }
                
                const following = followingSnap.val();
                const followingIds = Object.keys(following);
                
                // Load full user data for each followed user
                for (const followingId of followingIds) {
                    const userRef = window.firebaseRef(window.firebaseDB, `users/${followingId}`);
                    const userSnap = await window.firebaseGet(userRef);
                    
                    if (userSnap.exists()) {
                        const userData = userSnap.val();
                        
                        const followerDiv = document.createElement('div');
                        followerDiv.className = 'follower-item';
                        
                        const avatarContent = userData.profilePhoto 
                            ? `<img src="${userData.profilePhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                            : userData.pirateName.charAt(0).toUpperCase();
                        
                        followerDiv.innerHTML = `
                            <div class="follower-info" style="cursor: pointer;" onclick="viewUserProfile('${followingId}')">
                                <div class="follower-avatar">${avatarContent}</div>
                                <div class="follower-details">
                                    <div class="follower-name">${userData.pirateName}</div>
                                    <div class="follower-username">@${userData.username}</div>
                                    ${userData.bio ? `<div class="follower-bio">${userData.bio.length > 60 ? userData.bio.substring(0, 60) + '...' : userData.bio}</div>` : ''}
                                </div>
                            </div>
                            <button class="follow-btn following" onclick="toggleFollowFromModal('${followingId}', '${userData.username}')">
                                Following
                            </button>
                        `;
                        
                        list.appendChild(followerDiv);
                    }
                }
                
            } catch (e) {
                console.error('Load following error:', e);
                list.innerHTML = '<div class="followers-modal-empty">Error loading following list</div>';
            }
        }
        
        function closeFollowersModal() {
            document.getElementById('followersModal').classList.remove('active');
        }
        
        async function toggleFollowFromModal(targetUserId, targetUsername) {
            await toggleFollow(targetUserId, targetUsername);
            
            // Refresh the current modal
            const title = document.getElementById('followersModalTitle').textContent;
            if (title.includes('Followers')) {
                await showFollowers();
            } else {
                await showFollowing();
            }
        }
        
        // === USER PROFILE VIEW ===
        let viewedUser = null;
        
        async function viewUserProfile(userId) {
            if (!userId || userId === currentUser.userId) {
                // If clicking own profile, just go to profile page
                switchPage('profile');
                closeFollowersModal();
                return;
            }
            
            try {
                // Load user data
                const userRef = window.firebaseRef(window.firebaseDB, 'users/' + userId);
                const userSnap = await window.firebaseGet(userRef);
                
                if (!userSnap.exists()) {
                    alert('User not found');
                    return;
                }
                
                viewedUser = { userId, ...userSnap.val() };
                
                // Hide all pages
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('profilePage').style.display = 'none';
                document.getElementById('trendingPage').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'none';
                
                // Show user profile page
                document.getElementById('userProfilePage').style.display = 'block';
                
                // Close followers modal if open
                closeFollowersModal();
                
                // Set profile info
                document.getElementById('userProfileTitle').textContent = viewedUser.pirateName;
                document.getElementById('userProfilePirateName').textContent = viewedUser.pirateName;
                document.getElementById('userProfileUsername').textContent = '@' + viewedUser.username;
                
                // Set profile photo
                const userProfileAvatar = document.getElementById('userProfileAvatar');
                if (viewedUser.profilePhoto) {
                    userProfileAvatar.innerHTML = `<img src="${viewedUser.profilePhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    userProfileAvatar.textContent = viewedUser.pirateName.charAt(0).toUpperCase();
                }
                
                // Set banner
                const userProfileBanner = document.getElementById('userProfileBanner');
                if (viewedUser.banner) {
                    userProfileBanner.style.background = 'none';
                    userProfileBanner.style.backgroundImage = `url(${viewedUser.banner})`;
                    userProfileBanner.style.backgroundSize = 'cover';
                    userProfileBanner.style.backgroundPosition = 'center';
                } else {
                    userProfileBanner.style.background = 'linear-gradient(135deg, var(--terminal-green), var(--primary-gold))';
                    userProfileBanner.style.backgroundImage = 'none';
                }
                
                // Set bio
                const userProfileBio = document.getElementById('userProfileBio');
                if (viewedUser.bio) {
                    userProfileBio.textContent = viewedUser.bio;
                    userProfileBio.style.display = 'block';
                } else {
                    userProfileBio.textContent = 'No bio yet ðŸ´â€â˜ ï¸';
                    userProfileBio.style.opacity = '0.5';
                }
                
                // Update follow button
                const isFollowingUser = await isFollowing(userId);
                const followBtn = document.getElementById('userProfileFollowBtn');
                followBtn.textContent = isFollowingUser ? 'Following' : 'Follow';
                followBtn.className = isFollowingUser ? 'follow-btn following' : 'follow-btn';
                
                // Load stats
                await loadUserProfileStats(userId);
                
                // Load user's posts
                await loadUserProfilePosts(userId);
                
            } catch (e) {
                console.error('View user profile error:', e);
                alert('Error loading profile');
            }
        }
        
        async function loadUserProfileStats(userId) {
            try {
                // Load followers count
                const followersRef = window.firebaseRef(window.firebaseDB, `followers/${userId}`);
                const followersSnap = await window.firebaseGet(followersRef);
                const followersCount = followersSnap.exists() ? Object.keys(followersSnap.val()).length : 0;
                
                // Load following count
                const followingRef = window.firebaseRef(window.firebaseDB, `follows/${userId}`);
                const followingSnap = await window.firebaseGet(followingRef);
                const followingCount = followingSnap.exists() ? Object.keys(followingSnap.val()).length : 0;
                
                // Load posts
                const postsRef = window.firebaseRef(window.firebaseDB, 'posts');
                const postsSnap = await window.firebaseGet(postsRef);
                
                let postCount = 0;
                let totalLikes = 0;
                
                if (postsSnap.exists()) {
                    postsSnap.forEach(snap => {
                        const post = snap.val();
                        if (post.userId === userId) {
                            postCount++;
                            totalLikes += (post.likes || 0);
                        }
                    });
                }
                
                // Update UI
                document.getElementById('userProfileFollowersCount').textContent = followersCount;
                document.getElementById('userProfileFollowingCount').textContent = followingCount;
                document.getElementById('userProfilePostCount').textContent = postCount;
                document.getElementById('userProfileLikeCount').textContent = totalLikes;
                
            } catch (e) {
                console.error('Load user profile stats error:', e);
            }
        }
        
        async function loadUserProfilePosts(userId) {
            try {
                const postsRef = window.firebaseRef(window.firebaseDB, 'posts');
                const postsSnap = await window.firebaseGet(postsRef);
                
                let allPosts = [];
                
                // Load user's own posts
                if (postsSnap.exists()) {
                    postsSnap.forEach(snap => {
                        const post = { id: snap.key, ...snap.val() };
                        if (post.userId === userId) {
                            allPosts.push({
                                ...post,
                                timestamp: post.timestamp,
                                isRetweet: false
                            });
                        }
                    });
                }
                
                // Load user's retweets
                const userRetweetsRef = window.firebaseRef(window.firebaseDB, 'userRetweets/' + userId);
                const userRetweetsSnap = await window.firebaseGet(userRetweetsRef);
                
                if (userRetweetsSnap.exists()) {
                    const retweets = userRetweetsSnap.val();
                    
                    // Get retweeter's name
                    const retweeterRef = window.firebaseRef(window.firebaseDB, 'users/' + userId);
                    const retweeterSnap = await window.firebaseGet(retweeterRef);
                    const retweeterName = retweeterSnap.exists() ? retweeterSnap.val().pirateName : 'User';
                    
                    for (const postId in retweets) {
                        const retweetData = retweets[postId];
                        const postRef = window.firebaseRef(window.firebaseDB, 'posts/' + postId);
                        const postSnap = await window.firebaseGet(postRef);
                        
                        if (postSnap.exists()) {
                            const originalPost = { id: postSnap.key, ...postSnap.val() };
                            allPosts.push({
                                ...originalPost,
                                timestamp: retweetData.retweetTimestamp,
                                isRetweet: true,
                                retweeterName: retweeterName
                            });
                        }
                    }
                }
                
                // Sort posts by timestamp (newest first)
                allPosts.sort((a, b) => b.timestamp - a.timestamp);
                
                // Check like and retweet status if current user exists
                if (currentUser) {
                    for (let post of allPosts) {
                        const likeRef = window.firebaseRef(window.firebaseDB, 'likes/' + post.id + '/' + currentUser.userId);
                        const likeSnap = await window.firebaseGet(likeRef);
                        post.likedByCurrentUser = likeSnap.exists();
                        
                        const retweetRef = window.firebaseRef(window.firebaseDB, 'retweets/' + post.id + '/' + currentUser.userId);
                        const retweetSnap = await window.firebaseGet(retweetRef);
                        post.retweetedByCurrentUser = retweetSnap.exists();
                    }
                }
                
                // Display user posts
                const userProfilePosts = document.getElementById('userProfilePosts');
                userProfilePosts.innerHTML = '';
                
                if (allPosts.length === 0) {
                    userProfilePosts.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-white); opacity: 0.5;">No posts yet ðŸ´â€â˜ ï¸</div>';
                } else {
                    allPosts.forEach(post => {
                        const postEl = createPostElement(post, post.isRetweet, post.retweeterName);
                        userProfilePosts.appendChild(postEl);
                    });
                }
                
            } catch (e) {
                console.error('Load user profile posts error:', e);
            }
        }
        
        async function toggleUserProfileFollow() {
            if (!viewedUser) return;
            
            await toggleFollow(viewedUser.userId, viewedUser.username);
            
            // Update button
            const isFollowingUser = await isFollowing(viewedUser.userId);
            const followBtn = document.getElementById('userProfileFollowBtn');
            followBtn.textContent = isFollowingUser ? 'Following' : 'Follow';
            followBtn.className = isFollowingUser ? 'follow-btn following' : 'follow-btn';
            
            // Reload stats
            await loadUserProfileStats(viewedUser.userId);
        }
        
        function closeUserProfile() {
            viewedUser = null;
            switchPage('home');
        }
        
        // === SEARCH FUNCTIONALITY ===
        let currentSearchTab = 'all';
        let searchTimeout;
        
        function switchSearchTab(tab) {
            currentSearchTab = tab;
            
            // Update tab UI
            document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('searchTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            // Re-run search with current query
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                performSearch(query);
            }
        }
        
        function handleSearch(event) {
            clearTimeout(searchTimeout);
            const query = event.target.value.trim();
            
            if (!query) {
                document.getElementById('searchResults').innerHTML = `
                    <div style="text-align: center; color: var(--text-white); opacity: 0.5; padding: 40px;">
                        Type to search for users and posts ðŸ´â€â˜ ï¸
                    </div>
                `;
                return;
            }
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        }
        
        async function performSearch(query) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--terminal-green);">Searching... ðŸ”</div>';
            
            try {
                const lowerQuery = query.toLowerCase();
                let users = [];
                let posts = [];
                
                // Search users
                if (currentSearchTab === 'all' || currentSearchTab === 'users') {
                    const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                    const usersSnap = await window.firebaseGet(usersRef);
                    
                    if (usersSnap.exists()) {
                        usersSnap.forEach(snap => {
                            const user = { userId: snap.key, ...snap.val() };
                            if (user.pirateName.toLowerCase().includes(lowerQuery) || 
                                user.username.toLowerCase().includes(lowerQuery)) {
                                users.push(user);
                            }
                        });
                    }
                }
                
                // Search posts
                if (currentSearchTab === 'all' || currentSearchTab === 'posts') {
                    const postsRef = window.firebaseRef(window.firebaseDB, 'posts');
                    const postsSnap = await window.firebaseGet(postsRef);
                    
                    if (postsSnap.exists()) {
                        postsSnap.forEach(snap => {
                            const post = { id: snap.key, ...snap.val() };
                            
                            // Check if post has text field
                            const postText = post.text || '';
                            const postPirateName = post.pirateName || '';
                            const postUsername = post.username || '';
                            
                            // Search in post content, username, and pirate name
                            if (postText.toLowerCase().includes(lowerQuery) ||
                                postPirateName.toLowerCase().includes(lowerQuery) ||
                                postUsername.toLowerCase().includes(lowerQuery)) {
                                posts.push(post);
                                console.log('âœ… Found post:', post.text);
                            }
                        });
                    }
                    
                    console.log('ðŸ“Š Total posts found:', posts.length);
                }
                
                // Display results
                displaySearchResults(users, posts, query);
                
            } catch (e) {
                console.error('Search error:', e);
                searchResults.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--accent-red);">Search failed. Please try again.</div>';
            }
        }
        
        async function displaySearchResults(users, posts, query) {
            const searchResults = document.getElementById('searchResults');
            
            if (users.length === 0 && posts.length === 0) {
                searchResults.innerHTML = `
                    <div style="text-align: center; color: var(--text-white); opacity: 0.5; padding: 40px;">
                        No results found for "${query}" ðŸ´â€â˜ ï¸
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Display users
            if (users.length > 0 && (currentSearchTab === 'all' || currentSearchTab === 'users')) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h3 style="color: var(--primary-gold); padding: 10px 0; font-size: 1.1rem;">Users</h3>';
                
                users.forEach(user => {
                    const avatarContent = user.profilePhoto 
                        ? `<img src="${user.profilePhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                        : user.pirateName.charAt(0).toUpperCase();
                    
                    html += `
                        <div class="search-user-card" onclick="viewUserProfile('${user.userId}')">
                            <div class="search-user-avatar">${avatarContent}</div>
                            <div class="search-user-info">
                                <div class="search-user-name">${user.pirateName}</div>
                                <div class="search-user-handle">@${user.username}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Display posts
            if (posts.length > 0 && (currentSearchTab === 'all' || currentSearchTab === 'posts')) {
                html += '<div>';
                html += '<h3 style="color: var(--primary-gold); padding: 10px 0; font-size: 1.1rem;">Posts</h3>';
                html += '<div id="searchPostsContainer"></div>';
                html += '</div>';
            }
            
            searchResults.innerHTML = html;
            
            // Add posts using createPostElement
            if (posts.length > 0 && (currentSearchTab === 'all' || currentSearchTab === 'posts')) {
                const postsContainer = document.getElementById('searchPostsContainer');
                
                // Check like and retweet status for each post
                for (let post of posts) {
                    if (currentUser) {
                        const likeRef = window.firebaseRef(window.firebaseDB, 'likes/' + post.id + '/' + currentUser.userId);
                        const likeSnap = await window.firebaseGet(likeRef);
                        post.likedByCurrentUser = likeSnap.exists();
                        
                        const retweetRef = window.firebaseRef(window.firebaseDB, 'retweets/' + post.id + '/' + currentUser.userId);
                        const retweetSnap = await window.firebaseGet(retweetRef);
                        post.retweetedByCurrentUser = retweetSnap.exists();
                    }
                    
                    const postEl = createPostElement(post);
                    postsContainer.appendChild(postEl);
                }
            }
        }
    

        function loadMoreFeed() {
            const btn = document.getElementById('loadMoreBtn');
            if (btn) { btn.disabled = true; btn.textContent = 'Loadingâ€¦'; }

            const prevHeight = document.body.scrollHeight;
            window.FEED_LIMIT = Math.min((window.FEED_LIMIT || 50) + 50, 500);

            // Clear previous feed listener then reload to avoid stacking
            try { if (typeof feedUnsub === 'function') { feedUnsub(); feedUnsub = null; } } catch(e) {}
            loadFeed();

            // restore button
            setTimeout(() => {
                if (btn) { btn.disabled = false; btn.textContent = 'Load more'; }
                // keep position roughly stable
                const newHeight = document.body.scrollHeight;
                window.scrollBy(0, newHeight - prevHeight - 20);
            }, 600);
        }


        // ===== MVP: Linkify hashtags and mentions (v8) =====
        function linkifyText(text) {
            if (!text) return '';
            const escaped = escapeHtml(text);
            const withTags = escaped.replace(/(^|\s)(#[a-zA-Z0-9_]{2,50})/g, (m, p1, tag) => {
                const t = tag.substring(1);
                return `${p1}<a href="#" class="link-tag" data-linktype="hashtag" data-tag="${t}">${tag}</a>`;
            });
            const withMentions = withTags.replace(/(^|\s)(@[a-zA-Z0-9_]{2,30})/g, (m, p1, handle) => {
                const u = handle.substring(1);
                return `${p1}<a href="#" class="link-mention" data-linktype="mention" data-username="${u}">${handle}</a>`;
            });
            return withMentions;
        }

        function handleLinkifiedClick(e) {
            const a = e.target.closest('a[data-linktype]');
            if (!a) return;
            e.preventDefault();
            e.stopPropagation();

            const type = a.getAttribute('data-linktype');
            if (type === 'hashtag') {
                const tag = a.getAttribute('data-tag') || '';
                if (!tag) return;
                switchPage('search');
                const input = document.getElementById('searchInput');
                if (input) {
                    input.value = '#' + tag;
                    handleSearch({ key: 'Enter' });
                }
                return;
            }

            if (type === 'mention') {
                const username = a.getAttribute('data-username') || '';
                if (!username) return;

                try {
                    findUserIdByUsernameCached(username).then((uid) => {
                        if (uid) viewUserProfile(uid);
                    });
                } catch(e) {}
                return;
            }
        }

        document.addEventListener('click', handleLinkifiedClick, true);
        // ===== End linkify =====



        // ===== MVP: Infinite scroll (v8) =====
        function initInfiniteScroll() {
            let ticking = false;
            window.addEventListener('scroll', () => {
                if (ticking) return;
                ticking = true;
                requestAnimationFrame(() => {
                    ticking = false;
                    const btn = document.getElementById('loadMoreBtn');
                    if (!btn || btn.disabled) return;

                    const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 900);
                    if (nearBottom && infiniteScrollArmed) {
                        armInfiniteScroll();
                        loadMoreFeed();
                    }
                });
            }, { passive: true });
        }
        // ===== End infinite scroll =====



        // ===== MVP: Mention lookup cache (v9) =====
        const mentionUserCache = new Map(); // username -> userId|null
        async function findUserIdByUsernameCached(username) {
            if (!username) return null;
            const key = username.toLowerCase();
            if (mentionUserCache.has(key)) return mentionUserCache.get(key);

            return new Promise((resolve) => {
                try {
                    const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                    const q = window.firebaseQuery(usersRef, window.firebaseOrderByChild('username'), window.firebaseEqualTo(key));
                    const unsub = window.firebaseOnValue(q, (snap) => {
                        unsub();
                        let uid = null;
                        snap.forEach(child => { uid = child.key; });
                        mentionUserCache.set(key, uid);
                        resolve(uid);
                    });
                } catch(e) {
                    mentionUserCache.set(key, null);
                    resolve(null);
                }
            });
        }
        // ===== End cache =====



        // ===== MVP: Infinite scroll guard (v9) =====
        let infiniteScrollArmed = true;
        function armInfiniteScroll(delay=900){
            infiniteScrollArmed = false;
            setTimeout(()=>{ infiniteScrollArmed = true; }, delay);
        }



        // ===== MVP: Update counters without full re-render (v9) =====
        function updateVisiblePostCounters(posts) {
            try {
                posts.forEach(p => {
                    const el = document.querySelector(`.post[data-post-id="${p.id}"]`);
                    if (!el) return;

                    const stats = el.querySelectorAll('.post-stat span:last-child');
                    // Order: comment, retweet, like, views (based on existing markup)
                    if (stats && stats.length >= 4) {
                        stats[0].textContent = p.comments || 0;
                        stats[1].textContent = p.reposts || 0;
                        stats[2].textContent = p.likes || 0;
                        stats[3].textContent = p.views || 0;
                    }
                });
            } catch(e) {}
        }
        // ===== End counters =====



        // ===== MVP: Toast (v9) =====
        function showToast(message, ms=2200) {
            try {
                let el = document.getElementById('toast');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'toast';
                    el.className = 'toast';
                    document.body.appendChild(el);
                }
                el.textContent = message;
                el.classList.add('show');
                clearTimeout(el._t);
                el._t = setTimeout(() => el.classList.remove('show'), ms);
            } catch(e) {}
        }
        // ===== End toast =====



        // ===== MVP: User cache + batch fetch (v10) =====
        const userCacheV10 = new Map(); // userId -> userData|null

        async function getUserByIdCached(userId) {
            if (!userId) return null;
            if (userCacheV10.has(userId)) return userCacheV10.get(userId);

            try {
                const snap = await window.firebaseGet(window.firebaseRef(window.firebaseDB, `users/${userId}`));
                const data = snap.exists() ? snap.val() : null;
                userCacheV10.set(userId, data);
                return data;
            } catch(e) {
                userCacheV10.set(userId, null);
                return null;
            }
        }

        async function getUsersByIdsCached(ids, concurrency=6) {
            const out = new Map();
            const queue = (ids || []).filter(Boolean);
            let idx = 0;

            async function worker() {
                while (idx < queue.length) {
                    const i = idx++;
                    const id = queue[i];
                    const data = await getUserByIdCached(id);
                    out.set(id, data);
                }
            }

            const workers = Array.from({ length: Math.min(concurrency, queue.length) }, () => worker());
            await Promise.all(workers);
            return out;
        }
        // ===== End user cache =====



        // ===== MVP: Search render throttle (v10) =====
        let lastSearchQueryV10 = '';
        let lastSearchRenderKeyV10 = '';

        function renderSearchResultsV10(results) {
            const container = document.getElementById('searchResults');
            if (!container) return;

            const key = (results || []).map(r => r.id || r.userId || r.username || '').join('|');
            if (key === lastSearchRenderKeyV10) return;
            lastSearchRenderKeyV10 = key;

            container.innerHTML = '';
            if (!results || !results.length) {
                container.innerHTML = '<div style="text-align:center; padding: 40px; opacity:.6;">No results found. Try a different keyword, #hashtag, or @username.</div>';
                return;
            }

            const frag = document.createDocumentFragment();
            results.forEach(r => {
                if (r.type === 'user') {
                    const el = document.createElement('div');
                    el.className = 'search-result user-result';
                    const avatar = r.profilePhoto
                        ? `<img src="${r.profilePhoto}" loading="lazy" style="width: 44px; height: 44px; border-radius: 50%; object-fit: cover;">`
                        : `<div style="width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;color:var(--text-white);font-weight:800;">${(r.pirateName||'P').charAt(0).toUpperCase()}</div>`;
                    el.innerHTML = `
                        <div style="display:flex; gap:12px; align-items:center; padding: 12px 14px; cursor:pointer;">
                            ${avatar}
                            <div style="display:flex; flex-direction:column;">
                                <div style="color: var(--text-white); font-weight:800;">${escapeHtml(r.pirateName || 'Pirate')}</div>
                                <div style="opacity:.7;">@${escapeHtml(r.username || '')}</div>
                            </div>
                        </div>
                    `;
                    el.addEventListener('click', () => viewUserProfile(r.userId));
                    frag.appendChild(el);
                } else if (r.type === 'post') {
                    const el = createPostElement(r);
                    frag.appendChild(el);
                }
            });
            container.appendChild(frag);
        }
        // ===== End search render throttle =====



        // ===== MVP: Prevent background scroll when modals open (v10) =====
        function lockBodyScrollV10(lock) {
            try {
                document.body.style.overflow = lock ? 'hidden' : '';
            } catch(e) {}
        }

        // Wrap modal open/close if elements exist
        (function(){
            const _open = window.openCommentModal;
            const _close = window.closeCommentModal;
            if (typeof _open === 'function') {
                window.openCommentModal = async function(postId) {
                    lockBodyScrollV10(true);
                    return _open(postId);
                }
            }
            if (typeof _close === 'function') {
                window.closeCommentModal = function() {
                    lockBodyScrollV10(false);
                    return _close();
                }
            }
        })();
        // ===== End modal scroll lock =====



        // ===== MVP: Network awareness (v11) =====
        function setNetBanner(msg, show=true) {
            const b = document.getElementById('netBanner');
            if (!b) return;
            b.textContent = msg;
            b.classList.toggle('show', !!show);
        }

        window.addEventListener('offline', () => setNetBanner('You are offline. Some features may not work.', true));
        window.addEventListener('online', () => {
            setNetBanner('Back online âœ…', true);
            setTimeout(() => setNetBanner('', false), 1200);
        });
        // ===== End network =====



        // ===== MVP: Optimistic actions + lock (v11) =====
        const actionLocksV11 = new Map(); // key -> timestamp

        function withActionLock(key, fn, ttl=600) {
            const now = Date.now();
            const last = actionLocksV11.get(key) || 0;
            if (now - last < ttl) return false;
            actionLocksV11.set(key, now);
            try { fn(); } catch(e) {}
            return true;
        }

        function bumpCounterUI(postId, kind, delta) {
            try {
                const el = document.querySelector(`.post[data-post-id="${postId}"]`);
                if (!el) return;

                let idx = 0;
                if (kind === 'comment') idx = 0;
                if (kind === 'retweet') idx = 1;
                if (kind === 'like') idx = 2;
                if (kind === 'view') idx = 3;

                const spans = el.querySelectorAll('.post-stat span:last-child');
                if (!spans || spans.length < 4) return;

                const cur = parseInt(spans[idx].textContent || '0', 10) || 0;
                spans[idx].textContent = Math.max(0, cur + delta);
            } catch(e) {}
        }

        // Wrap likePost / retweetPost to lock and reduce double taps
        (function(){
            const _like = window.likePost;
            const _rt = window.retweetPost;

            if (typeof _like === 'function') {
                window.likePost = function(postId) {
                    return withActionLock(`like:${postId}:${currentUser?.userId||''}`, () => _like(postId));
                }
            }
            if (typeof _rt === 'function') {
                window.retweetPost = function(postId) {
                    return withActionLock(`rt:${postId}:${currentUser?.userId||''}`, () => _rt(postId));
                }
            }
        })();
        // ===== End optimistic =====



        // ===== MVP: Global error toast (v11) =====
        window.addEventListener('error', (e) => {
            try {
                const msg = (e && e.message) ? e.message : 'Unexpected error';
                if (typeof showToast === 'function') showToast(`âš ï¸ ${msg}`, 2600);
            } catch(_) {}
        });

        window.addEventListener('unhandledrejection', (e) => {
            try {
                const msg = (e && e.reason && e.reason.message) ? e.reason.message : 'Unexpected error';
                if (typeof showToast === 'function') showToast(`âš ï¸ ${msg}`, 2600);
            } catch(_) {}
        });
        // ===== End global error =====



        // ===== MVP: Feed scroll stability (v12) =====
        let feedLastRenderTsV12 = 0;

        function isNearTopV12() {
            return window.scrollY < 220;
        }

        function preserveScrollWhileUpdating(fn) {
            try {
                const nearTop = isNearTopV12();
                const beforeTop = window.scrollY;
                const beforeHeight = document.body.scrollHeight;

                fn();

                if (!nearTop) {
                    const afterHeight = document.body.scrollHeight;
                    const delta = afterHeight - beforeHeight;
                    if (delta > 0) window.scrollTo(0, beforeTop + delta);
                }
            } catch(e) { fn(); }
        }
        // ===== End feed scroll =====



        // ===== MVP: Notifications diff render (v12) =====
        let lastNotifKeyV12 = '';

        function renderNotificationsSafeV12(items) {
            const list = document.getElementById('notificationsOverlayList');
            const empty = document.getElementById('notificationsOverlayEmpty');
            if (!list) return;

            const key = (items || []).map(n => n.id).join('|');
            if (key && key === lastNotifKeyV12) return;
            lastNotifKeyV12 = key;

            if (!items || !items.length) {
                list.innerHTML = '';
                if (empty) empty.style.display = 'block';
                return;
            }
            if (empty) empty.style.display = 'none';

            const frag = document.createDocumentFragment();
            items.forEach(n => {
                const row = document.createElement('div');
                row.className = 'notif-row';

                const avatar = n.actorProfilePhoto
                    ? `<img class="notif-avatar-img" src="${n.actorProfilePhoto}" loading="lazy">`
                    : `<div class="notif-avatar-fallback">${(n.actorPirateName || 'P').charAt(0).toUpperCase()}</div>`;

                const actorName = escapeHtml(n.actorPirateName || 'Pirate');
                const actorHandle = escapeHtml(n.actorUsername || '');
                const actionText = n.type === 'like' ? 'liked your post' : (n.type === 'retweet' ? 'reposted your post' : (n.type === 'comment' ? 'commented on your post' : (n.type === 'follow' ? 'followed you' : 'interacted')));
                const timeAgo = getTimeAgo(n.createdAt || n.timestamp || Date.now());

                row.innerHTML = `
                    <div class="notif-avatar">${avatar}</div>
                    <div class="notif-main">
                        <div class="notif-line">
                            <span class="notif-name">${actorName}</span>
                            <span class="notif-handle">@${actorHandle}</span>
                            <span class="notif-time">Â· ${timeAgo}</span>
                        </div>
                        <div class="notif-text">${actionText}</div>
                    </div>
                `;

                // click: open post if present
                row.addEventListener('click', () => {
                    if (n.postId) openPostDetailModal(n.postId);
                });

                frag.appendChild(row);
            });

            list.innerHTML = '';
            list.appendChild(frag);
        }
        // ===== End notifications diff render =====



        // ===== MVP: Real Trending from posts (v13) =====
        let trendingUnsub = null;

        function extractHashtags(text) {
            if (!text) return [];
            const matches = text.match(/#[a-zA-Z0-9_]{2,50}/g);
            if (!matches) return [];
            return matches.map(t => t.toLowerCase());
        }

        function formatCount(n) {
            const num = Number(n) || 0;
            if (num >= 1_000_000) return (num/1_000_000).toFixed(1).replace(/\.0$/,'') + 'M';
            if (num >= 1_000) return (num/1_000).toFixed(1).replace(/\.0$/,'') + 'K';
            return String(num);
        }

        function renderTrending(items) {
            const list = document.getElementById('trendingList');
            const loading = document.getElementById('trendingLoading');
            if (!list) return;

            if (loading) loading.style.display = 'none';
            list.innerHTML = '';

            if (!items || !items.length) {
                list.innerHTML = '<div style="opacity:.6; padding: 10px 0;">No trending hashtags yet.</div>';
                return;
            }

            items.slice(0, 5).forEach((it, i) => {
                const div = document.createElement('div');
                div.className = 'trending-item';
                div.innerHTML = `
                    <div class="trending-category">Crypto Â· Trending</div>
                    <div class="trending-topic">${escapeHtml(it.tag)}</div>
                    <div class="trending-count">${formatCount(it.count)} posts</div>
                `;
                div.addEventListener('click', () => {
                    switchPage('search');
                    const input = document.getElementById('searchInput');
                    if (input) {
                        input.value = it.tag;
                        handleSearch({ key: 'Enter' });
                    }
                });
                list.appendChild(div);
            });
        }

        function computeTrendingFromPosts(postsObj) {
            const counts = new Map();
            let total = 0;

            Object.keys(postsObj || {}).forEach((postId) => {
                const p = postsObj[postId];
                if (!p) return;
                total++;

                const tags = extractHashtags(p.text || p.content || '');
                tags.forEach(t => counts.set(t, (counts.get(t) || 0) + 1));
            });

            const items = Array.from(counts.entries())
                .sort((a,b) => b[1]-a[1])
                .slice(0, 8)
                .map(([tag,count]) => ({ tag, count }));

            renderTrending(items);
        }

        function startTrendingListener() {
            try {
                if (trendingUnsub) { trendingUnsub(); trendingUnsub = null; }

                const postsRef = window.firebaseRef(window.firebaseDB, 'posts');
                // Use a larger window for trending than the feed.
                const q = window.firebaseQuery(postsRef, window.firebaseOrderByChild('createdAt'), window.firebaseLimitToLast(500));

                trendingUnsub = window.firebaseOnValue(q, (snap) => {
                    const obj = snap.exists() ? snap.val() : {};
                    computeTrendingFromPosts(obj);
                }, (err) => {
                    console.error('Trending error:', err);
                    const loading = document.getElementById('trendingLoading');
                    if (loading) loading.textContent = 'Could not load trending.';
                });
            } catch(e) {
                console.error('startTrendingListener error:', e);
            }
        }
        // ===== End Trending =====

</script>

    <!-- Notifications Overlay (failsafe) -->
    <div id="notificationsOverlay" class="notif-overlay" style="display:none;">
        <div class="notif-overlay-backdrop" onclick="closeNotificationsOverlay()"></div>
        <div class="notif-overlay-panel">
            <div class="notif-overlay-header">
                <div class="notif-overlay-title">ðŸ”” Notifications</div>
                <div class="notif-overlay-actions">
                    <button class="mark-read-btn" onclick="markAllNotificationsRead()">Mark all as read</button>
                    <button class="notif-overlay-close" onclick="closeNotificationsOverlay()">âœ•</button>
                </div>
            </div>
            <div id="notificationsOverlayList"></div>
        </div>
    </div>

<div class="mobile-backdrop" onclick="toggleMobileSidebar(false)"></div>
<div id="netBanner" class="net-banner">You are offline. Some features may not work.</div>
</body>
</html>
